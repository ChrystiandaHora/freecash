{% extends "base.html" %}
{% block content %}

{{ meses_labels|json_script:"mesesLabels" }}
{{ receitas_6m|json_script:"receitas6m" }}
{{ despesas_6m|json_script:"despesas6m" }}
{{ saldos_6m|json_script:"saldos6m" }}

{{ dias_labels|json_script:"diasLabels" }}
{{ receitas_dias|json_script:"receitasDias" }}
{{ despesas_dias|json_script:"despesasDias" }}

<div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">

  <!-- Top bar -->
  <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
    <div class="space-y-1">
      <h1 class="text-xl font-semibold text-gray-900">Dashboard</h1>
      <p class="text-sm text-gray-500">Visão rápida do {{ periodo_label|lower }}</p>
    </div>

    <div class="flex flex-col sm:flex-row sm:items-center gap-3">
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">Período</span>
        <select
          class="text-sm border border-gray-200 rounded-xl px-3 py-2 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-900/10"
          onchange="setPeriodo(this.value)">
          <option value="0" {% if periodo == 0 %}selected{% endif %}>Mês atual</option>
          <option value="1" {% if periodo == 1 %}selected{% endif %}>Mês passado</option>
          <option value="2" {% if periodo == 2 %}selected{% endif %}>Mês retrasado</option>
        </select>
      </div>

      <div class="flex items-center gap-2">
        <a href="{% url 'contas_pagar' %}"
           class="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold
                  bg-gray-900 text-white hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-900/20">
          Gerenciar contas
        </a>
        <a href="{% url 'transacoes' %}"
           class="inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-semibold
                  bg-gray-100 text-gray-900 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-900/10">
          Ver transações
        </a>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">

    <!-- Receita -->
    <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-4">
      <div class="flex items-center justify-between">
        <p class="text-sm text-gray-500">Receitas</p>
        {% if receitas_pct != None %}
          {% if receitas_pct >= 0 %}
            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-green-50 text-green-700 border border-green-100">
              +{{ receitas_pct|floatformat:1 }}%
            </span>
          {% else %}
            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-50 text-red-700 border border-red-100">
              {{ receitas_pct|floatformat:1 }}%
            </span>
          {% endif %}
        {% else %}
          <span class="text-xs px-2 py-1 rounded-full bg-gray-50 text-gray-600 border border-gray-100">sem base</span>
        {% endif %}
      </div>
      <p class="mt-2 text-2xl font-semibold text-gray-900">R$ {{ total_receitas|floatformat:2 }}</p>
      <p class="mt-1 text-xs text-gray-500">vs mês anterior</p>
    </div>

    <!-- Despesa -->
    <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-4">
      <div class="flex items-center justify-between">
        <p class="text-sm text-gray-500">Despesas</p>
        {% if despesas_pct != None %}
          {% if despesas_pct <= 0 %}
            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-green-50 text-green-700 border border-green-100">
              {{ despesas_pct|floatformat:1 }}%
            </span>
          {% else %}
            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-50 text-red-700 border border-red-100">
              +{{ despesas_pct|floatformat:1 }}%
            </span>
          {% endif %}
        {% else %}
          <span class="text-xs px-2 py-1 rounded-full bg-gray-50 text-gray-600 border border-gray-100">sem base</span>
        {% endif %}
      </div>
      <p class="mt-2 text-2xl font-semibold text-gray-900">R$ {{ total_despesas|floatformat:2 }}</p>
      <p class="mt-1 text-xs text-gray-500">vs mês anterior</p>
    </div>

    <!-- Saldo -->
    <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-4">
      <div class="flex items-center justify-between">
        <p class="text-sm text-gray-500">Saldo</p>
        <span class="text-xs px-2 py-1 rounded-full bg-gray-50 text-gray-600 border border-gray-100">
          {{ periodo_label|lower }}
        </span>
      </div>
      <p class="mt-2 text-2xl font-semibold text-gray-900">R$ {{ saldo_mes|floatformat:2 }}</p>
      {% if taxa_poupanca != None %}
        <p class="mt-1 text-xs text-gray-500">Poupança: {{ taxa_poupanca|floatformat:0 }}%</p>
      {% else %}
        <p class="mt-1 text-xs text-gray-500">Sem base</p>
      {% endif %}
    </div>

    <!-- Contas -->
    <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-4">
      <p class="text-sm text-gray-500">Contas</p>
      <div class="mt-2 flex items-baseline justify-between">
        <p class="text-2xl font-semibold text-gray-900">
          {{ contas_pendentes|default:0 }} pendentes
        </p>
        <p class="text-xs text-gray-500 text-right">
          {{ contas_atrasadas|default:0 }} atrasadas
        </p>
      </div>
      <p class="mt-1 text-xs text-gray-500">status geral</p>
    </div>

  </div>

  <!-- Main layout -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left: insights -->
    <div class="lg:col-span-2 space-y-6">

      <!-- Primary chart: cashflow -->
      <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-5">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
          <div class="space-y-1">
            <div class="flex items-center gap-2">
              <h2 class="text-sm font-semibold text-gray-900">Fluxo de caixa</h2>
              <span class="text-gray-400 cursor-help" title="Ative séries para comparar tendências">
                <i class="fa-solid fa-circle-info"></i>
              </span>
            </div>
            <p class="text-xs text-gray-500">Últimos 6 meses</p>
          </div>

          <div class="inline-flex rounded-xl bg-gray-50 p-1 border border-gray-100">
            <button id="btnSavings"
              class="px-3 py-1.5 text-xs font-semibold rounded-lg bg-white shadow-sm text-gray-900">
              Saldo
            </button>
            <button id="btnIncome"
              class="px-3 py-1.5 text-xs font-semibold rounded-lg text-gray-700 hover:text-gray-900">
              Receita
            </button>
            <button id="btnExpense"
              class="px-3 py-1.5 text-xs font-semibold rounded-lg text-gray-700 hover:text-gray-900">
              Despesa
            </button>
          </div>
        </div>

        <div class="mt-4 h-64">
          <canvas id="graficoMeses"></canvas>
        </div>
      </div>

      <!-- Unified card: Receitas vs Despesas (tabs) -->
      <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-5">
        <div class="flex items-center justify-between gap-3">
          <div class="space-y-1">
            <h2 class="text-sm font-semibold text-gray-900">Movimento diário</h2>
            <p class="text-xs text-gray-500">No período selecionado</p>
          </div>

          <div class="inline-flex rounded-xl bg-gray-50 p-1 border border-gray-100" role="tablist" aria-label="Movimento diário">
            <button
              class="tab-btn px-3 py-1.5 text-xs font-semibold rounded-lg bg-white shadow-sm text-gray-900"
              data-tab="tab-receitas" aria-selected="true" type="button">
              Receitas
            </button>
            <button
              class="tab-btn px-3 py-1.5 text-xs font-semibold rounded-lg text-gray-700 hover:text-gray-900"
              data-tab="tab-despesas" aria-selected="false" type="button">
              Despesas
            </button>
          </div>
        </div>

        <!-- Tab: receitas -->
        <div id="tab-receitas" class="tab-panel mt-4">
          <div class="flex items-end justify-between gap-4">
            <div>
              <p class="text-xs text-gray-500">Total</p>
              <p class="mt-1 text-lg font-semibold text-gray-900">R$ {{ total_receitas|floatformat:2 }}</p>
            </div>
            <p class="text-xs text-gray-500">linha diária</p>
          </div>
          <div class="mt-3 h-52">
            <canvas id="chartReceitas"></canvas>
          </div>
        </div>

        <!-- Tab: despesas -->
        <div id="tab-despesas" class="tab-panel mt-4 hidden">
          <div class="flex items-start justify-between gap-4">
            <div>
              <p class="text-xs text-gray-500">Total</p>
              <p class="mt-1 text-lg font-semibold text-gray-900">R$ {{ total_despesas|floatformat:2 }}</p>
              <p class="mt-1 text-xs text-gray-500">linha diária e categorias</p>
            </div>
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between mb-2">
              <p class="text-sm font-semibold text-gray-800">Categorias</p>
              <p class="text-xs text-gray-500">Top + outros</p>
            </div>

            {% if breakdown_items %}
              <div class="h-8 rounded-lg bg-gray-100 overflow-hidden flex border border-gray-100">
                {% for item in breakdown_items %}
                  <div
                    title="{{ item.nome }}: R$ {{ item.valor|floatformat:2 }} ({{ item.pct|floatformat:0 }}%)"
                    class="{% if forloop.counter0 == 0 %}bg-orange-600{% elif forloop.counter0 == 1 %}bg-orange-400{% elif forloop.counter0 == 2 %}bg-orange-300{% elif forloop.counter0 == 3 %}bg-orange-200{% else %}bg-gray-300{% endif %}"
                    style="width: {{ item.pct|floatformat:2|cut:',' }}%;">
                  </div>
                {% endfor %}
              </div>

              <div class="mt-3 space-y-1">
                {% for item in breakdown_items %}
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-700 font-medium truncate max-w-[60%]">{{ item.nome }}</span>
                    <span class="text-gray-500 tabular-nums">
                      R$ {{ item.valor|floatformat:2 }} • {{ item.pct|floatformat:0 }}%
                    </span>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-sm text-gray-500">Sem dados de categorias no período.</p>
            {% endif %}

            <div class="mt-4 h-28">
              <canvas id="chartDespesasMini"></canvas>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Right: secondary info -->
    <div class="space-y-6">

      <!-- Próximas contas -->
      <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-5">
        <div class="flex items-center justify-between">
          <div class="space-y-1">
            <h2 class="text-sm font-semibold text-gray-900">Próximas contas</h2>
            <p class="text-xs text-gray-500">Organize o que vem aí</p>
          </div>
          <a href="{% url 'contas_pagar' %}"
             class="w-9 h-9 rounded-xl border border-gray-200 text-gray-700 text-lg leading-none inline-flex items-center justify-center hover:bg-gray-50">
            +
          </a>
        </div>

        <div class="mt-4 space-y-3">
          {% for c in upcoming_bills %}
            <div class="border border-gray-100 rounded-2xl p-4 hover:bg-gray-50/60 transition-colors">
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <p class="text-sm font-semibold text-gray-900 truncate">{{ c.descricao }}</p>
                  <p class="text-xs text-gray-500 mt-1">{{ c.data_vencimento|date:"d/m/Y" }}</p>
                  {% if c.categoria %}
                    <p class="text-xs text-gray-500">{{ c.categoria.nome }}</p>
                  {% endif %}
                </div>

                <div class="text-right shrink-0">
                  <p class="text-sm font-semibold text-gray-900 tabular-nums">R$ {{ c.valor|floatformat:2 }}</p>
                  <span class="inline-flex mt-2 text-xs px-2 py-1 rounded-full bg-gray-50 text-gray-600 border border-gray-100">
                    Programado
                  </span>
                </div>
              </div>
            </div>
          {% empty %}
            <p class="text-sm text-gray-500">Nenhuma conta pendente futura.</p>
          {% endfor %}
        </div>

        <a href="{% url 'contas_pagar' %}"
          class="mt-4 inline-flex w-full items-center justify-center rounded-xl
                 bg-gray-100 hover:bg-gray-200 text-gray-900 text-sm font-semibold py-2
                 focus:outline-none focus:ring-2 focus:ring-gray-900/10">
          Ver tudo
        </a>
      </div>

      <!-- Status das contas -->
      <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-5">
        <div class="flex items-center justify-between">
          <div class="space-y-1">
            <h2 class="text-sm font-semibold text-gray-900">Status das contas</h2>
            <p class="text-xs text-gray-500">Pagas, pendentes e atrasadas</p>
          </div>
        </div>
        <div class="mt-4 h-56">
          <canvas id="graficoContas"></canvas>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const brl = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" });

  function setPeriodo(value) {
    const url = new URL(window.location.href);
    url.searchParams.set("periodo", value);
    window.location.href = url.toString();
  }

  function makeGradient(ctx, top, bottom) {
    const g = ctx.createLinearGradient(0, 0, 0, 180);
    g.addColorStop(0, top);
    g.addColorStop(1, bottom);
    return g;
  }

  function makeDailyLine(canvasId, labels, dataArr, borderColor, fillTop, fillBottom) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;

    const ctx = canvas.getContext("2d");
    const bg = makeGradient(ctx, fillTop, fillBottom);

    return new Chart(canvas, {
      type: "line",
      data: {
        labels,
        datasets: [{
          data: dataArr,
          tension: 0.35,
          borderColor,
          backgroundColor: bg,
          borderWidth: 2,
          pointRadius: 2,
          pointHoverRadius: 4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (items) => `Dia ${items?.[0]?.label || ""}`,
              label: (ctx) => brl.format(ctx.parsed.y || 0)
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: {
              maxRotation: 0,
              callback: (value, index) => {
                const label = labels[index] || "";
                const day = Number(label);
                return (day === 1 || day % 5 === 0) ? label : "";
              }
            }
          },
          y: {
            beginAtZero: true,
            ticks: { callback: (v) => brl.format(v) }
          }
        }
      }
    });
  }

  // JSON
  const mesesLabels = JSON.parse(document.getElementById("mesesLabels").textContent);
  const receitas6m = JSON.parse(document.getElementById("receitas6m").textContent).map(v => Number(v) || 0);
  const despesas6m = JSON.parse(document.getElementById("despesas6m").textContent).map(v => Number(v) || 0);
  const saldos6m = JSON.parse(document.getElementById("saldos6m").textContent).map(v => Number(v) || 0);

  const diasLabels = JSON.parse(document.getElementById("diasLabels").textContent);
  const receitasDias = JSON.parse(document.getElementById("receitasDias").textContent).map(v => Number(v) || 0);
  const despesasDias = JSON.parse(document.getElementById("despesasDias").textContent).map(v => Number(v) || 0);

  makeDailyLine("chartReceitas", diasLabels, receitasDias, "#16a34a", "rgba(34,197,94,0.22)", "rgba(34,197,94,0)");
  makeDailyLine("chartDespesasMini", diasLabels, despesasDias, "#f97316", "rgba(249,115,22,0.20)", "rgba(249,115,22,0)");

  // Tabs (Receitas/Despesas)
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabPanels = document.querySelectorAll(".tab-panel");

  function setActiveTab(tabId) {
    tabPanels.forEach(p => p.classList.toggle("hidden", p.id !== tabId));
    tabButtons.forEach(b => {
      const active = b.dataset.tab === tabId;
      b.setAttribute("aria-selected", String(active));
      b.classList.toggle("bg-white", active);
      b.classList.toggle("shadow-sm", active);
      b.classList.toggle("text-gray-900", active);
      b.classList.toggle("text-gray-700", !active);
    });
  }

  tabButtons.forEach(btn => btn.addEventListener("click", () => setActiveTab(btn.dataset.tab)));

  // Donut contas
  const donutEl = document.getElementById("graficoContas");
  if (donutEl) {
    const pagas = Number("{{ contas_pagas|default:0 }}");
    const pendentes = Number("{{ contas_pendentes|default:0 }}");
    const atrasadas = Number("{{ contas_atrasadas|default:0 }}");

    let labels = ["Pagas", "Pendentes", "Atrasadas"];
    let data = [pagas, pendentes, atrasadas];
    let colors = ["#22c55e", "#3b82f6", "#ef4444"];

    if ((pagas + pendentes + atrasadas) === 0) {
      labels = ["Sem contas"];
      data = [1];
      colors = ["#e5e7eb"];
    }

    new Chart(donutEl, {
      type: "doughnut",
      data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } }, cutout: "70%" }
    });
  }

  // Fluxo de caixa
  const cashFlowEl = document.getElementById("graficoMeses");
  let cashFlowChart = null;

  function setButtonState(btn, active) {
    if (!btn) return;
    btn.classList.toggle("bg-white", active);
    btn.classList.toggle("shadow-sm", active);
    btn.classList.toggle("text-gray-900", active);
    btn.classList.toggle("bg-transparent", !active);
    btn.classList.toggle("text-gray-700", !active);
  }

  function toggleDataset(idx, btn) {
    if (!cashFlowChart) return;
    const ds = cashFlowChart.data.datasets[idx];
    ds.hidden = !ds.hidden;
    cashFlowChart.update();
    setButtonState(btn, !ds.hidden);
  }

  if (cashFlowEl) {
    cashFlowChart = new Chart(cashFlowEl, {
      type: "line",
      data: {
        labels: mesesLabels,
        datasets: [
          { label: "Receita", data: receitas6m, borderColor: "#16a34a", borderWidth: 2, tension: 0.35, pointRadius: 2, fill: false, hidden: true },
          { label: "Despesa", data: despesas6m, borderColor: "#ef4444", borderWidth: 2, tension: 0.35, pointRadius: 2, fill: false, hidden: true },
          { label: "Saldo", data: saldos6m, borderColor: "#3b82f6", borderWidth: 3, tension: 0.35, pointRadius: 3, fill: false, hidden: false },
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "top" },
          tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${brl.format(ctx.parsed.y || 0)}` } }
        },
        scales: {
          x: { grid: { display: false } },
          y: {
            beginAtZero: true,
            grid: { color: (ctx) => (ctx.tick.value === 0 ? "#9ca3af" : "rgba(156,163,175,0.2)") },
            ticks: { callback: (v) => brl.format(v) }
          }
        }
      }
    });
  }

  const btnIncome = document.getElementById("btnIncome");
  const btnExpense = document.getElementById("btnExpense");
  const btnSavings = document.getElementById("btnSavings");

  if (btnIncome) { btnIncome.addEventListener("click", () => toggleDataset(0, btnIncome)); setButtonState(btnIncome, false); }
  if (btnExpense) { btnExpense.addEventListener("click", () => toggleDataset(1, btnExpense)); setButtonState(btnExpense, false); }
  if (btnSavings) { btnSavings.addEventListener("click", () => toggleDataset(2, btnSavings)); setButtonState(btnSavings, true); }
</script>

{% endblock %}
