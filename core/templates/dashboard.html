{% extends "base.html" %}
{% block content %}

{# JSON seguro #}
{{ meses_labels|json_script:"mesesLabels" }}
{{ receitas_6m|json_script:"receitas6m" }}
{{ despesas_6m|json_script:"despesas6m" }}
{{ saldos_6m|json_script:"saldos6m" }}

{{ dias_labels|json_script:"diasLabels" }}
{{ receitas_dias|json_script:"receitasDias" }}
{{ despesas_dias|json_script:"despesasDias" }}


<div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">

  <!-- Top 3 small cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

    <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-4">
      <p class="text-sm text-gray-500">Receitas do mês</p>
      <p class="mt-1 text-2xl font-bold text-gray-900">R$ {{ total_receitas|floatformat:2 }}</p>
      <div class="mt-2">
        {% if receitas_pct != None %}
          {% if receitas_pct >= 0 %}
            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-green-100 text-green-700">
              +{{ receitas_pct|floatformat:1 }}% vs mês anterior
            </span>
          {% else %}
            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-700">
              {{ receitas_pct|floatformat:1 }}% vs mês anterior
            </span>
          {% endif %}
        {% else %}
          <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">
            sem base para comparação
          </span>
        {% endif %}
      </div>
    </div>

    <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-4">
      <p class="text-sm text-gray-500">Despesas do mês</p>
      <p class="mt-1 text-2xl font-bold text-gray-900">R$ {{ total_despesas|floatformat:2 }}</p>
      <div class="mt-2">
        {% if despesas_pct != None %}
          {% if despesas_pct <= 0 %}
            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-green-100 text-green-700">
              {{ despesas_pct|floatformat:1 }}% vs mês anterior
            </span>
          {% else %}
            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-700">
              +{{ despesas_pct|floatformat:1 }}% vs mês anterior
            </span>
          {% endif %}
        {% else %}
          <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">
            sem base para comparação
          </span>
        {% endif %}
      </div>
    </div>

    <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-4">
      <p class="text-sm text-gray-500">Saldo do mês</p>
      <p class="mt-1 text-2xl font-bold text-gray-900">R$ {{ saldo_mes|floatformat:2 }}</p>
      <p class="mt-2 text-xs text-gray-500">Receitas menos despesas (mês atual)</p>
    </div>

  </div>

  <!-- Main grid like the print -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left: main content -->
    <div class="lg:col-span-2 space-y-6">

      <!-- Row 1: two overview cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Visão geral dos ganhos -->
        <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-5">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <h2 class="text-sm font-semibold text-gray-800">Visão geral dos ganhos</h2>
              <span class="text-gray-400 cursor-help" title="Receitas ao longo dos últimos 6 meses">ⓘ</span>
            </div>
            <select
              class="text-sm border border-gray-200 rounded-lg px-3 py-1 bg-white"
              onchange="setPeriodo(this.value)">
              <option value="0" {% if periodo == 0 %}selected{% endif %}>Mês atual</option>
              <option value="1" {% if periodo == 1 %}selected{% endif %}>Mês passado</option>
              <option value="2" {% if periodo == 2 %}selected{% endif %}>Mês retrasado</option>
            </select>
          </div>

          <div class="mt-3 flex items-center gap-3">
            <p class="text-3xl font-bold text-gray-900">R$ {{ total_receitas|floatformat:2 }}</p>
            {% if receitas_pct != None %}
              {% if receitas_pct >= 0 %}
                <span class="text-xs font-semibold px-2 py-1 rounded-full bg-green-100 text-green-700">
                  +{{ receitas_pct|floatformat:1 }}%
                </span>
              {% else %}
                <span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-700">
                  {{ receitas_pct|floatformat:1 }}%
                </span>
              {% endif %}
            {% else %}
              <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">sem base</span>
            {% endif %}
          </div>

          <div class="mt-4 h-40">
            <canvas id="chartReceitas"></canvas>
          </div>
        </div>

        <!-- Visão geral dos gastos -->
        <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-5">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <h2 class="text-sm font-semibold text-gray-800">Visão geral dos gastos</h2>
              <span class="text-gray-400 cursor-help" title="Despesas e distribuição por categoria no mês">ⓘ</span>
            </div>
            <select
              class="text-sm border border-gray-200 rounded-lg px-3 py-1 bg-white"
              onchange="setPeriodo(this.value)">
              <option value="0" {% if periodo == 0 %}selected{% endif %}>Mês atual</option>
              <option value="1" {% if periodo == 1 %}selected{% endif %}>Mês passado</option>
              <option value="2" {% if periodo == 2 %}selected{% endif %}>Mês retrasado</option>
            </select>
          </div>

          <div class="mt-3 flex items-center gap-3">
            <p class="text-3xl font-bold text-gray-900">R$ {{ total_despesas|floatformat:2 }}</p>
            {% if despesas_pct != None %}
              {% if despesas_pct <= 0 %}
                <span class="text-xs font-semibold px-2 py-1 rounded-full bg-green-100 text-green-700">
                  {{ despesas_pct|floatformat:1 }}%
                </span>
              {% else %}
                <span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-700">
                  +{{ despesas_pct|floatformat:1 }}%
                </span>
              {% endif %}
            {% else %}
              <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">sem base</span>
            {% endif %}
          </div>

          <div class="mt-5">
            <p class="text-sm font-semibold text-gray-700 mb-3">Discriminação das despesas</p>

            <div class="flex flex-wrap gap-4 text-xs text-gray-700">
              {% for item in breakdown_items|slice:":3" %}
                <div class="flex items-center gap-2">
                  <span class="inline-block w-2 h-2 rounded-full bg-orange-500"></span>
                  <span class="font-semibold">{{ item.nome }}</span>
                  <span class="text-gray-500">R$ {{ item.valor|floatformat:2 }}</span>
                </div>
              {% empty %}
                <span class="text-gray-500">Sem dados de categorias no mês.</span>
              {% endfor %}
            </div>

            <div class="mt-3 h-8 rounded-lg bg-gray-100 overflow-hidden flex">
              {% for item in breakdown_items %}
                <div
                  class="{% if forloop.counter0 == 0 %}bg-orange-600{% elif forloop.counter0 == 1 %}bg-orange-400{% elif forloop.counter0 == 2 %}bg-orange-300{% else %}bg-gray-300{% endif %}"
                  style="width: {{ item.pct|floatformat:2 }}%">
                </div>
              {% endfor %}
            </div>

            <div class="mt-4 h-24">
              <canvas id="chartDespesasMini"></canvas>
            </div>
          </div>
        </div>

      </div>

      <!-- Row 2: Fluxo de caixa -->
      <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-5">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <h2 class="text-sm font-semibold text-gray-800">Fluxo de caixa</h2>
            <span class="text-gray-400 cursor-help" title="Comparação mensal nos últimos 6 meses">ⓘ</span>
          </div>

          <div class="flex items-center gap-2">
            <button id="btnIncome" class="text-xs font-semibold px-3 py-1 rounded-full bg-gray-900 text-white">Renda</button>
            <button id="btnExpense" class="text-xs font-semibold px-3 py-1 rounded-full bg-gray-100 text-gray-700">Despesa</button>
            <button id="btnSavings" class="text-xs font-semibold px-3 py-1 rounded-full bg-gray-100 text-gray-700">Poupança</button>
          </div>
        </div>

        <div class="mt-3">
          <p class="text-3xl font-bold text-gray-900">R$ {{ saldo_mes|floatformat:2 }}</p>
          <p class="text-xs text-gray-500">Saldo do {{ periodo_label|lower }}</p>
        </div>

        <div class="mt-4 h-56">
          <canvas id="graficoMeses"></canvas>
        </div>
      </div>

      <!-- Row 3: Transação recentes -->
      <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-semibold text-gray-800">Transação recente</h2>
          <button class="text-xs font-semibold px-3 py-1 rounded-lg border border-gray-200 text-gray-700">Filtro</button>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="border-b text-xs text-gray-500">
                <th class="py-2 font-semibold">Data</th>
                <th class="py-2 font-semibold">Tipo</th>
                <th class="py-2 font-semibold">Valor</th>
                <th class="py-2 font-semibold">Descrição</th>
              </tr>
            </thead>
            <tbody class="text-sm">
              {% for t in ultimas_transacoes %}
              <tr class="border-b">
                <td class="py-3 text-gray-700">{{ t.data|date:"d/m/Y" }}</td>
                <td class="py-3 text-gray-700">{{ t.get_tipo_display }}</td>
                <td class="py-3 font-semibold text-gray-900">R$ {{ t.valor|floatformat:2 }}</td>
                <td class="py-3 text-gray-700">{{ t.descricao }}</td>
              </tr>
              {% empty %}
              <tr>
                <td class="py-3 text-gray-500" colspan="4">Sem transações recentes.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- Right: side content -->
    <div class="space-y-6">

      <!-- Próximas contas e pagamentos -->
      <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-semibold text-gray-800">Próximas contas e pagamentos</h2>
          <button class="w-9 h-9 rounded-xl border border-gray-200 text-gray-700 text-lg leading-none">+</button>
        </div>

        <div class="mt-4 space-y-3">
          {% for c in upcoming_bills %}
            <div class="border border-gray-100 rounded-2xl p-4 flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-gray-900">{{ c.descricao }}</p>
                <p class="text-xs text-gray-500">{{ c.data_vencimento|date:"d/m/Y" }}</p>
                {% if c.categoria %}
                  <p class="text-xs text-gray-500">{{ c.categoria.nome }}</p>
                {% endif %}
              </div>

              <div class="text-right">
                <p class="text-sm font-bold text-gray-900">R$ {{ c.valor|floatformat:2 }}</p>
                <span class="inline-block mt-1 text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">
                  Programado
                </span>
              </div>
            </div>
          {% empty %}
            <p class="text-sm text-gray-500">Nenhuma conta pendente futura.</p>
          {% endfor %}
        </div>

        <button class="mt-4 w-full bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm font-semibold py-2 rounded-xl">
          Ver tudo
        </button>
      </div>

      <!-- Status das contas -->
      <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-6">
        <h2 class="text-sm font-semibold text-gray-800 mb-4">Status das contas</h2>
        <div class="h-56">
          <canvas id="graficoContas"></canvas>
        </div>
      </div>

      <!-- Resumo 3 meses -->
      <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-6">
        <h2 class="text-sm font-semibold text-gray-800 mb-4">Resumo dos últimos 3 meses</h2>

        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="border-b text-xs text-gray-500">
                <th class="py-2 font-semibold">Mês</th>
                <th class="py-2 font-semibold">Receita</th>
                <th class="py-2 font-semibold">Outras</th>
                <th class="py-2 font-semibold">Gastos</th>
                <th class="py-2 font-semibold">Total</th>
              </tr>
            </thead>
            <tbody class="text-sm">
              {% for r in resumo_3_meses %}
              <tr class="border-b">
                <td class="py-3 text-gray-700">{{ r.mes }}/{{ r.ano }}</td>
                <td class="py-3 text-gray-700">R$ {{ r.receita|floatformat:2 }}</td>
                <td class="py-3 text-gray-700">R$ {{ r.outras_receitas|floatformat:2 }}</td>
                <td class="py-3 text-gray-700">R$ {{ r.gastos|floatformat:2 }}</td>
                <td class="py-3 font-semibold text-gray-900">R$ {{ r.total|floatformat:2 }}</td>
              </tr>
              {% empty %}
              <tr>
                <td class="py-3 text-gray-500" colspan="5">Sem resumo.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>

  </div>
</div>

<script>
  // Helpers
  const brl = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" });

  function setPeriodo(value) {
    const url = new URL(window.location.href);
    url.searchParams.set("periodo", value);
    window.location.href = url.toString();
  }

  function makeGradient(ctx, rgbaTop, rgbaBottom) {
    const g = ctx.createLinearGradient(0, 0, 0, 180);
    g.addColorStop(0, rgbaTop);
    g.addColorStop(1, rgbaBottom);
    return g;
  }

  function makeDailyLine(canvasId, labels, dataArr, borderColor, fillTop, fillBottom) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;

    const ctx = canvas.getContext("2d");
    const bg = makeGradient(ctx, fillTop, fillBottom);

    return new Chart(canvas, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: canvasId,
          data: dataArr,
          tension: 0.35,
          borderColor,
          backgroundColor: bg,
          borderWidth: 2,
          pointRadius: 2,
          pointHoverRadius: 4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (items) => `Dia ${items?.[0]?.label || ""}`,
              label: (ctx) => brl.format(ctx.parsed.y || 0)
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: {
              maxRotation: 0,
              callback: (value, index, ticks) => {
                // mostra menos ticks para não poluir
                const label = labels[index] || "";
                const day = Number(label);
                return (day === 1 || day % 5 === 0) ? label : "";
              }
            }
          },
          y: {
            beginAtZero: true,
            ticks: { callback: (v) => brl.format(v) }
          }
        }
      }
    });
  }

  // JSON do backend
  const mesesLabels = JSON.parse(document.getElementById("mesesLabels").textContent);
  const receitas6m = JSON.parse(document.getElementById("receitas6m").textContent).map(v => Number(v) || 0);
  const despesas6m = JSON.parse(document.getElementById("despesas6m").textContent).map(v => Number(v) || 0);
  const saldos6m = JSON.parse(document.getElementById("saldos6m").textContent).map(v => Number(v) || 0);

  const diasLabels = JSON.parse(document.getElementById("diasLabels").textContent);
  const receitasDias = JSON.parse(document.getElementById("receitasDias").textContent).map(v => Number(v) || 0);
  const despesasDias = JSON.parse(document.getElementById("despesasDias").textContent).map(v => Number(v) || 0);

  // 1) Visão geral dos ganhos: diário
  makeDailyLine(
    "chartReceitas",
    diasLabels,
    receitasDias,
    "#16a34a",
    "rgba(34,197,94,0.22)",
    "rgba(34,197,94,0)"
  );

  // 2) Visão geral dos gastos: diário (mini)
  makeDailyLine(
    "chartDespesasMini",
    diasLabels,
    despesasDias,
    "#f97316",
    "rgba(249,115,22,0.20)",
    "rgba(249,115,22,0)"
  );

  // 3) Donut status contas (mantém seu gráfico, com fallback se tudo for 0)
  const donutEl = document.getElementById("graficoContas");
  if (donutEl) {
    const pagas = Number("{{ contas_pagas|default:0 }}");
    const pendentes = Number("{{ contas_pendentes|default:0 }}");
    const atrasadas = Number("{{ contas_atrasadas|default:0 }}");

    let labels = ["Pagas", "Pendentes", "Atrasadas"];
    let data = [pagas, pendentes, atrasadas];
    let colors = ["#22c55e", "#3b82f6", "#ef4444"];

    if ((pagas + pendentes + atrasadas) === 0) {
      labels = ["Sem contas"];
      data = [1];
      colors = ["#e5e7eb"];
    }

    new Chart(donutEl, {
      type: "doughnut",
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: colors,
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: "bottom" } },
        cutout: "70%"
      }
    });
  }

  // 4) Fluxo de caixa: LINE chart (6 meses) com 3 linhas (Receita, Gasto, Saldo)
  const cashFlowEl = document.getElementById("graficoMeses");
  let cashFlowChart = null;

  if (cashFlowEl) {
    cashFlowChart = new Chart(cashFlowEl, {
      type: "line",
      data: {
        labels: mesesLabels,
        datasets: [
          {
            label: "Receita",
            data: receitas6m,
            borderColor: "#16a34a",
            backgroundColor: "rgba(34,197,94,0.10)",
            borderWidth: 2,
            tension: 0.35,
            pointRadius: 2,
            fill: false
          },
          {
            label: "Gasto",
            data: despesas6m,
            borderColor: "#ef4444",
            backgroundColor: "rgba(239,68,68,0.10)",
            borderWidth: 2,
            tension: 0.35,
            pointRadius: 2,
            fill: false
          },
          {
            label: "Saldo",
            data: saldos6m,
            borderColor: "#3b82f6",
            backgroundColor: "rgba(59,130,246,0.10)",
            borderWidth: 2,
            tension: 0.35,
            pointRadius: 2,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "top" },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${brl.format(ctx.parsed.y || 0)}`
            }
          }
        },
        scales: {
          x: { grid: { display: false } },
          y: {
            beginAtZero: true,
            ticks: { callback: (v) => brl.format(v) }
          }
        }
      }
    });
  }

  // Botões: agora eles ligam/desligam linhas do fluxo de caixa
  const btnIncome = document.getElementById("btnIncome");
  const btnExpense = document.getElementById("btnExpense");
  const btnSavings = document.getElementById("btnSavings");

  function setButtonState(btn, active) {
    if (!btn) return;
    if (active) {
      btn.classList.add("bg-gray-900", "text-white");
      btn.classList.remove("bg-gray-100", "text-gray-700");
    } else {
      btn.classList.remove("bg-gray-900", "text-white");
      btn.classList.add("bg-gray-100", "text-gray-700");
    }
  }

  function toggleDataset(idx, btn) {
    if (!cashFlowChart) return;
    const ds = cashFlowChart.data.datasets[idx];
    ds.hidden = !ds.hidden;
    cashFlowChart.update();
    setButtonState(btn, !ds.hidden);
  }

  if (btnIncome) {
    btnIncome.addEventListener("click", () => toggleDataset(0, btnIncome));
    setButtonState(btnIncome, true);
  }
  if (btnExpense) {
    btnExpense.addEventListener("click", () => toggleDataset(1, btnExpense));
    setButtonState(btnExpense, true);
  }
  if (btnSavings) {
    btnSavings.addEventListener("click", () => toggleDataset(2, btnSavings));
    setButtonState(btnSavings, true);
  }
</script>

{% endblock %}
