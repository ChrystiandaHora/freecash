{% extends "base.html" %}
{% block content %}

{{ meses_labels|json_script:"mesesLabels" }}
{{ receitas_6m|json_script:"receitas6m" }}
{{ despesas_6m|json_script:"despesas6m" }}
{{ saldos_6m|json_script:"saldos6m" }}

{{ dias_labels|json_script:"diasLabels" }}
{{ receitas_dias|json_script:"receitasDias" }}
{{ despesas_dias|json_script:"despesasDias" }}

<div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-4 space-y-4">

  <!-- Compact Top Bar -->
  <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
        <i class="fa-solid fa-chart-line text-emerald-500"></i> Dashboard
        <span class="text-sm font-normal text-gray-500 dark:text-slate-400">• {{ periodo_label }}</span>
      </h1>
    </div>

    <div class="flex flex-wrap items-center gap-2">
      <select
        class="text-xs border border-gray-200 dark:border-slate-700 rounded-lg px-2 py-1.5 bg-white dark:bg-slate-800 text-gray-900 dark:text-white shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/50"
        onchange="setPeriodo(this.value)">
        <option value="0" {% if periodo == 0 %}selected{% endif %}>Mês atual</option>
        <option value="1" {% if periodo == 1 %}selected{% endif %}>Mês passado</option>
        <option value="2" {% if periodo == 2 %}selected{% endif %}>Mês retrasado</option>
      </select>

      <a href="{% url 'contas_pagar' %}"
         class="inline-flex items-center rounded-lg px-3 py-1.5 text-xs font-semibold
                bg-emerald-600 text-white hover:bg-emerald-500 transition-all">
        <i class="fa-solid fa-plus mr-1.5"></i> Nova conta
      </a>
    </div>
  </div>

  <!-- KPI Row: Compact 4-column grid -->
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">

    <!-- Receita -->
    <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-xl p-3">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center">
          <i class="fa-solid fa-arrow-trend-up text-emerald-600 dark:text-emerald-400 text-sm"></i>
        </div>
        <div class="min-w-0 flex-1">
          <p class="text-xs text-gray-500 dark:text-slate-400">Receitas</p>
          <p class="text-base font-bold text-gray-900 dark:text-white truncate">R$ {{ total_receitas|floatformat:2 }}</p>
        </div>
        {% if receitas_pct != None %}
          <span class="text-[10px] font-semibold px-1.5 py-0.5 rounded-full shrink-0 {% if receitas_pct >= 0 %}bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400{% else %}bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400{% endif %}">
            {% if receitas_pct >= 0 %}+{% endif %}{{ receitas_pct|floatformat:0 }}%
          </span>
        {% endif %}
      </div>
    </div>

    <!-- Despesa -->
    <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-xl p-3">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
          <i class="fa-solid fa-arrow-trend-down text-red-600 dark:text-red-400 text-sm"></i>
        </div>
        <div class="min-w-0 flex-1">
          <p class="text-xs text-gray-500 dark:text-slate-400">Despesas</p>
          <p class="text-base font-bold text-gray-900 dark:text-white truncate">R$ {{ total_despesas|floatformat:2 }}</p>
        </div>
        {% if despesas_pct != None %}
          <span class="text-[10px] font-semibold px-1.5 py-0.5 rounded-full shrink-0 {% if despesas_pct <= 0 %}bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400{% else %}bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400{% endif %}">
            {% if despesas_pct > 0 %}+{% endif %}{{ despesas_pct|floatformat:0 }}%
          </span>
        {% endif %}
      </div>
    </div>

    <!-- Saldo -->
    <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-xl p-3">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
          <i class="fa-solid fa-wallet text-blue-600 dark:text-blue-400 text-sm"></i>
        </div>
        <div class="min-w-0 flex-1">
          <p class="text-xs text-gray-500 dark:text-slate-400">Saldo</p>
          <p class="text-base font-bold {% if saldo_mes >= 0 %}text-emerald-600 dark:text-emerald-400{% else %}text-red-600 dark:text-red-400{% endif %} truncate">R$ {{ saldo_mes|floatformat:2 }}</p>
        </div>
        {% if taxa_poupanca != None %}
          <span class="text-[10px] font-medium px-1.5 py-0.5 rounded-full bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-300 shrink-0">
            {{ taxa_poupanca|floatformat:0 }}% poup.
          </span>
        {% endif %}
      </div>
    </div>

    <!-- Contas Pendentes -->
    <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-xl p-3">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
          <i class="fa-regular fa-calendar-check text-purple-600 dark:text-purple-400 text-sm"></i>
        </div>
        <div class="min-w-0 flex-1">
          <p class="text-xs text-gray-500 dark:text-slate-400">Pendentes</p>
          <p class="text-base font-bold text-gray-900 dark:text-white">{{ contas_pendentes|default:0 }}</p>
        </div>
        {% if contas_atrasadas > 0 %}
          <span class="text-[10px] font-semibold px-1.5 py-0.5 rounded-full bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 shrink-0">
            {{ contas_atrasadas }} atras.
          </span>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- Main Grid: Better proportions -->
  <div class="grid grid-cols-1 xl:grid-cols-12 gap-4">

    <!-- Left Column: Charts -->
    <div class="xl:col-span-8 space-y-4">

      <!-- Cash Flow Chart -->
      <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-xl p-4">
        <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
          <h2 class="text-sm font-semibold text-gray-900 dark:text-white">Fluxo de caixa <span class="text-xs font-normal text-gray-500 dark:text-slate-400">(6 meses)</span></h2>
          <div class="inline-flex rounded-lg bg-gray-100 dark:bg-slate-700/50 p-0.5 text-[11px]">
            <button id="btnSavings" class="px-2 py-1 rounded-md bg-white dark:bg-slate-600 shadow-sm text-gray-900 dark:text-white font-semibold">Saldo</button>
            <button id="btnIncome" class="px-2 py-1 rounded-md text-gray-600 dark:text-slate-400 font-medium hover:text-gray-900 dark:hover:text-white">Receita</button>
            <button id="btnExpense" class="px-2 py-1 rounded-md text-gray-600 dark:text-slate-400 font-medium hover:text-gray-900 dark:hover:text-white">Despesa</button>
          </div>
        </div>
        <div class="h-48">
          <canvas id="graficoMeses"></canvas>
        </div>
      </div>

      <!-- Daily Movement: More compact with inline tabs -->
      <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-xl p-4">
        <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
          <h2 class="text-sm font-semibold text-gray-900 dark:text-white">Movimento diário</h2>
          <div class="inline-flex rounded-lg bg-gray-100 dark:bg-slate-700/50 p-0.5 text-[11px]" role="tablist">
            <button class="tab-btn px-2 py-1 rounded-md bg-white dark:bg-slate-600 shadow-sm text-gray-900 dark:text-white font-semibold" data-tab="tab-receitas" aria-selected="true" type="button">Receitas</button>
            <button class="tab-btn px-2 py-1 rounded-md text-gray-600 dark:text-slate-400 font-medium hover:text-gray-900 dark:hover:text-white" data-tab="tab-despesas" aria-selected="false" type="button">Despesas</button>
          </div>
        </div>

        <!-- Tab: Receitas -->
        <div id="tab-receitas" class="tab-panel">
          <div class="flex items-baseline justify-between mb-2">
            <p class="text-lg font-bold text-emerald-600 dark:text-emerald-400">R$ {{ total_receitas|floatformat:2 }}</p>
            <p class="text-[10px] text-gray-500 dark:text-slate-400">total do período</p>
          </div>
          <div class="h-36">
            <canvas id="chartReceitas"></canvas>
          </div>
        </div>

        <!-- Tab: Despesas -->
        <div id="tab-despesas" class="tab-panel hidden">
          <div class="flex items-baseline justify-between mb-2">
            <p class="text-lg font-bold text-red-600 dark:text-red-400">R$ {{ total_despesas|floatformat:2 }}</p>
            <p class="text-[10px] text-gray-500 dark:text-slate-400">total do período</p>
          </div>

          {% if breakdown_items %}
            <!-- Compact category bar -->
            <div class="h-3 rounded-full bg-gray-100 dark:bg-slate-700/50 overflow-hidden flex mb-2">
              {% for item in breakdown_items %}
                <div
                  title="{{ item.nome }}: R$ {{ item.valor|floatformat:2 }} ({{ item.pct|floatformat:0 }}%)"
                  class="{% if forloop.counter0 == 0 %}bg-orange-500{% elif forloop.counter0 == 1 %}bg-orange-400{% elif forloop.counter0 == 2 %}bg-orange-300{% elif forloop.counter0 == 3 %}bg-orange-200{% else %}bg-gray-300{% endif %}"
                  style="width: {{ item.pct|floatformat:2|cut:',' }}%;"></div>
              {% endfor %}
            </div>
            <div class="flex flex-wrap gap-x-3 gap-y-1 text-[10px] mb-3">
              {% for item in breakdown_items %}
                <span class="text-gray-600 dark:text-slate-400">
                  <span class="font-medium text-gray-800 dark:text-slate-200">{{ item.nome|truncatechars:12 }}</span> {{ item.pct|floatformat:0 }}%
                </span>
              {% endfor %}
            </div>
          {% endif %}

          <div class="h-24">
            <canvas id="chartDespesasMini"></canvas>
          </div>
        </div>
      </div>

    </div>

    <!-- Right Column: Quick Actions & Status -->
    <div class="xl:col-span-4 space-y-4">

      <!-- Próximas Contas: Compact list -->
      <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-xl p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-sm font-semibold text-gray-900 dark:text-white">Próximas contas</h2>
          <a href="{% url 'contas_pagar' %}" class="text-xs text-emerald-600 dark:text-emerald-400 hover:underline">Ver todas</a>
        </div>

        <div class="space-y-2">
          {% for c in upcoming_bills %}
            <div class="flex items-center justify-between gap-2 p-2 rounded-lg border border-gray-100 dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors">
              <div class="min-w-0 flex-1">
                <p class="text-sm font-medium text-gray-900 dark:text-white truncate">{{ c.descricao }}</p>
                <p class="text-[10px] text-gray-500 dark:text-slate-400">{{ c.data_vencimento|date:"d/m" }}{% if c.categoria %} • {{ c.categoria.nome|truncatechars:10 }}{% endif %}</p>
              </div>
              <p class="text-sm font-semibold text-gray-900 dark:text-white tabular-nums shrink-0">R$ {{ c.valor|floatformat:2 }}</p>
            </div>
          {% empty %}
            <p class="text-xs text-gray-500 dark:text-slate-400 text-center py-4">Nenhuma conta pendente</p>
          {% endfor %}
        </div>
      </div>

      <!-- Status das Contas: Mini donut -->
      <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-xl p-4">
        <h2 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Status das contas</h2>
        <div class="h-40">
          <canvas id="graficoContas"></canvas>
        </div>
        <!-- Legend inline -->
        <div class="flex justify-center gap-4 mt-2 text-[10px]">
          <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Pagas {{ contas_pagas|default:0 }}</span>
          <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Pendentes {{ contas_pendentes|default:0 }}</span>
          <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> Atrasadas {{ contas_atrasadas|default:0 }}</span>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-xl p-4">
        <h2 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Atalhos rápidos</h2>
        <div class="grid grid-cols-2 gap-2">
          <a href="{% url 'contas_pagar' %}" class="flex items-center gap-2 p-2 rounded-lg border border-gray-100 dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors text-xs">
            <i class="fa-solid fa-file-invoice-dollar text-gray-500 dark:text-slate-400"></i>
            <span class="text-gray-700 dark:text-slate-300">Contas</span>
          </a>
          <a href="{% url 'receitas' %}" class="flex items-center gap-2 p-2 rounded-lg border border-gray-100 dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors text-xs">
            <i class="fa-solid fa-coins text-gray-500 dark:text-slate-400"></i>
            <span class="text-gray-700 dark:text-slate-300">Receitas</span>
          </a>
          <a href="{% url 'formas_pagamento' %}" class="flex items-center gap-2 p-2 rounded-lg border border-gray-100 dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors text-xs">
            <i class="fa-solid fa-credit-card text-gray-500 dark:text-slate-400"></i>
            <span class="text-gray-700 dark:text-slate-300">Pagamentos</span>
          </a>
          <a href="{% url 'transacoes' %}" class="flex items-center gap-2 p-2 rounded-lg border border-gray-100 dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors text-xs">
            <i class="fa-solid fa-list text-gray-500 dark:text-slate-400"></i>
            <span class="text-gray-700 dark:text-slate-300">Transações</span>
          </a>
        </div>
      </div>

    </div>
  </div>

</div>

<script>
  const brl = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" });

  function setPeriodo(value) {
    const url = new URL(window.location.href);
    url.searchParams.set("periodo", value);
    window.location.href = url.toString();
  }

  function makeGradient(ctx, top, bottom) {
    const g = ctx.createLinearGradient(0, 0, 0, 120);
    g.addColorStop(0, top);
    g.addColorStop(1, bottom);
    return g;
  }

  function makeDailyLine(canvasId, labels, dataArr, borderColor, fillTop, fillBottom) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;

    const ctx = canvas.getContext("2d");
    const bg = makeGradient(ctx, fillTop, fillBottom);

    return new Chart(canvas, {
      type: "line",
      data: {
        labels,
        datasets: [{
          data: dataArr,
          tension: 0.4,
          borderColor,
          backgroundColor: bg,
          borderWidth: 1.5,
          pointRadius: 0,
          pointHoverRadius: 3,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (items) => `Dia ${items?.[0]?.label || ""}`,
              label: (ctx) => brl.format(ctx.parsed.y || 0)
            }
          }
        },
        scales: {
          x: {
            display: false
          },
          y: {
            display: false,
            beginAtZero: true
          }
        }
      }
    });
  }

  // JSON
  const mesesLabels = JSON.parse(document.getElementById("mesesLabels").textContent);
  const receitas6m = JSON.parse(document.getElementById("receitas6m").textContent).map(v => Number(v) || 0);
  const despesas6m = JSON.parse(document.getElementById("despesas6m").textContent).map(v => Number(v) || 0);
  const saldos6m = JSON.parse(document.getElementById("saldos6m").textContent).map(v => Number(v) || 0);

  const diasLabels = JSON.parse(document.getElementById("diasLabels").textContent);
  const receitasDias = JSON.parse(document.getElementById("receitasDias").textContent).map(v => Number(v) || 0);
  const despesasDias = JSON.parse(document.getElementById("despesasDias").textContent).map(v => Number(v) || 0);

  makeDailyLine("chartReceitas", diasLabels, receitasDias, "#16a34a", "rgba(34,197,94,0.15)", "rgba(34,197,94,0)");
  makeDailyLine("chartDespesasMini", diasLabels, despesasDias, "#f97316", "rgba(249,115,22,0.15)", "rgba(249,115,22,0)");

  // Tabs
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabPanels = document.querySelectorAll(".tab-panel");

  function setActiveTab(tabId) {
    tabPanels.forEach(p => p.classList.toggle("hidden", p.id !== tabId));
    tabButtons.forEach(b => {
      const active = b.dataset.tab === tabId;
      b.setAttribute("aria-selected", String(active));
      if (active) {
        b.classList.remove("text-gray-600", "dark:text-slate-400");
        b.classList.add("bg-white", "dark:bg-slate-600", "shadow-sm", "text-gray-900", "dark:text-white", "font-semibold");
      } else {
        b.classList.remove("bg-white", "dark:bg-slate-600", "shadow-sm", "text-gray-900", "dark:text-white", "font-semibold");
        b.classList.add("text-gray-600", "dark:text-slate-400", "font-medium");
      }
    });
  }

  tabButtons.forEach(btn => btn.addEventListener("click", () => setActiveTab(btn.dataset.tab)));

  // Donut
  const donutEl = document.getElementById("graficoContas");
  if (donutEl) {
    const pagas = Number("{{ contas_pagas|default:0 }}");
    const pendentes = Number("{{ contas_pendentes|default:0 }}");
    const atrasadas = Number("{{ contas_atrasadas|default:0 }}");

    let labels = ["Pagas", "Pendentes", "Atrasadas"];
    let data = [pagas, pendentes, atrasadas];
    let colors = ["#22c55e", "#3b82f6", "#ef4444"];

    if ((pagas + pendentes + atrasadas) === 0) {
      labels = ["Sem contas"];
      data = [1];
      colors = ["#e5e7eb"];
    }

    new Chart(donutEl, {
      type: "doughnut",
      data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        cutout: "75%"
      }
    });
  }

  // Cash flow chart
  const cashFlowEl = document.getElementById("graficoMeses");
  let cashFlowChart = null;

  function setButtonState(btn, active) {
    if (!btn) return;
    if (active) {
      btn.classList.remove("text-gray-600", "dark:text-slate-400");
      btn.classList.add("bg-white", "dark:bg-slate-600", "shadow-sm", "text-gray-900", "dark:text-white", "font-semibold");
    } else {
      btn.classList.remove("bg-white", "dark:bg-slate-600", "shadow-sm", "text-gray-900", "dark:text-white", "font-semibold");
      btn.classList.add("text-gray-600", "dark:text-slate-400", "font-medium");
    }
  }

  function toggleDataset(idx, btn) {
    if (!cashFlowChart) return;
    const ds = cashFlowChart.data.datasets[idx];
    ds.hidden = !ds.hidden;
    cashFlowChart.update();
    setButtonState(btn, !ds.hidden);
  }

  if (cashFlowEl) {
    cashFlowChart = new Chart(cashFlowEl, {
      type: "line",
      data: {
        labels: mesesLabels,
        datasets: [
          { label: "Receita", data: receitas6m, borderColor: "#16a34a", borderWidth: 2, tension: 0.4, pointRadius: 2, fill: false, hidden: true },
          { label: "Despesa", data: despesas6m, borderColor: "#ef4444", borderWidth: 2, tension: 0.4, pointRadius: 2, fill: false, hidden: true },
          { label: "Saldo", data: saldos6m, borderColor: "#3b82f6", borderWidth: 2.5, tension: 0.4, pointRadius: 3, fill: false, hidden: false },
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${brl.format(ctx.parsed.y || 0)}` } }
        },
        scales: {
          x: { grid: { display: false }, ticks: { font: { size: 10 } } },
          y: {
            beginAtZero: true,
            grid: { color: "rgba(156,163,175,0.1)" },
            ticks: { font: { size: 10 }, callback: (v) => brl.format(v) }
          }
        }
      }
    });
  }

  const btnIncome = document.getElementById("btnIncome");
  const btnExpense = document.getElementById("btnExpense");
  const btnSavings = document.getElementById("btnSavings");

  if (btnIncome) { btnIncome.addEventListener("click", () => toggleDataset(0, btnIncome)); setButtonState(btnIncome, false); }
  if (btnExpense) { btnExpense.addEventListener("click", () => toggleDataset(1, btnExpense)); setButtonState(btnExpense, false); }
  if (btnSavings) { btnSavings.addEventListener("click", () => toggleDataset(2, btnSavings)); setButtonState(btnSavings, true); }
</script>

{% endblock %}
