{% extends "base.html" %}
{% block content %}

{{ meses_labels|json_script:"mesesLabels" }}
{{ receitas_6m|json_script:"receitas6m" }}
{{ despesas_6m|json_script:"despesas6m" }}
{{ saldos_6m|json_script:"saldos6m" }}

{{ dias_labels|json_script:"diasLabels" }}
{{ receitas_dias|json_script:"receitasDias" }}
{{ despesas_dias|json_script:"despesasDias" }}

<div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-xl font-bold text-gray-900">Dashboard</h1>
      <p class="text-sm text-gray-500">Visão rápida do {{ periodo_label|lower }}</p>
    </div>

    <div class="flex items-center gap-3">
      <span class="text-sm text-gray-600">Período</span>
      <select
        class="text-sm border border-gray-200 rounded-xl px-3 py-2 bg-white"
        onchange="setPeriodo(this.value)">
        <option value="0" {% if periodo == 0 %}selected{% endif %}>Mês atual</option>
        <option value="1" {% if periodo == 1 %}selected{% endif %}>Mês passado</option>
        <option value="2" {% if periodo == 2 %}selected{% endif %}>Mês retrasado</option>
      </select>
    </div>
  </div>

  <!-- KPI row -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-4">
      <p class="text-sm text-gray-500">Receitas</p>
      <div class="mt-1 flex items-baseline gap-2">
        <p class="text-2xl font-bold text-gray-900">R$ {{ total_receitas|floatformat:2 }}</p>
        {% if receitas_pct != None %}
          {% if receitas_pct >= 0 %}
            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-green-100 text-green-700">
              +{{ receitas_pct|floatformat:1 }}% vs mês anterior
            </span>
          {% else %}
            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-700">
              {{ receitas_pct|floatformat:1 }}% vs mês anterior
            </span>
          {% endif %}
        {% else %}
          <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">sem base</span>
        {% endif %}
      </div>
    </div>

    <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-4">
      <p class="text-sm text-gray-500">Despesas</p>
      <div class="mt-1 flex items-baseline gap-2">
        <p class="text-2xl font-bold text-gray-900">R$ {{ total_despesas|floatformat:2 }}</p>
        {% if despesas_pct != None %}
          {% if despesas_pct <= 0 %}
            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-green-100 text-green-700">
              {{ despesas_pct|floatformat:1 }}% vs mês anterior
            </span>
          {% else %}
            <span class="text-xs font-semibold px-2 py-1 rounded-full bg-red-100 text-red-700">
              +{{ despesas_pct|floatformat:1 }}% vs mês anterior
            </span>
          {% endif %}
        {% else %}
          <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">sem base</span>
        {% endif %}
      </div>
    </div>

    <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-4">
      <p class="text-sm text-gray-500">Saldo</p>
      <p class="mt-1 text-2xl font-bold text-gray-900">R$ {{ saldo_mes|floatformat:2 }}</p>
      {% if taxa_poupanca != None %}
        <p class="mt-2 text-xs text-gray-500">Taxa de poupança: {{ taxa_poupanca|floatformat:0 }}%</p>
      {% else %}
        <p class="mt-2 text-xs text-gray-500">Sem base (sem receitas)</p>
      {% endif %}
    </div>
  </div>

  <!-- Main grid -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Left -->
    <div class="lg:col-span-2 space-y-6">

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Ganhos -->
        <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-5">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <h2 class="text-sm font-semibold text-gray-800">Ganhos no período</h2>
              <span class="text-gray-400 cursor-help" title="Receitas por dia no período selecionado">
                <i class="fa-solid fa-circle-info"></i>
              </span>
            </div>
          </div>

          <div class="mt-3">
            <p class="text-2xl font-bold text-gray-900">R$ {{ total_receitas|floatformat:2 }}</p>
            <p class="text-xs text-gray-500">linha diária</p>
          </div>

          <div class="mt-4 h-44">
            <canvas id="chartReceitas"></canvas>
          </div>
        </div>

        <!-- Gastos -->
        <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-5">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <h2 class="text-sm font-semibold text-gray-800">Gastos no período</h2>
              <span class="text-gray-400 cursor-help" title="Despesas por dia e participação por categoria">
                <i class="fa-solid fa-circle-info"></i>
              </span>
            </div>
          </div>

          <div class="mt-3">
            <p class="text-2xl font-bold text-gray-900">R$ {{ total_despesas|floatformat:2 }}</p>
            <p class="text-xs text-gray-500">linha diária + distribuição</p>
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between mb-2">
              <p class="text-sm font-semibold text-gray-700">Distribuição por categoria</p>
              <p class="text-xs text-gray-500">Top categorias + outros</p>
            </div>

            {% if breakdown_items %}
              <div class="mt-2 h-8 rounded-lg bg-gray-100 overflow-hidden flex">
                {% for item in breakdown_items %}
                  <div
                    title="{{ item.nome }}: R$ {{ item.valor|floatformat:2 }} ({{ item.pct|floatformat:0 }}%)"
                    class="{% if forloop.counter0 == 0 %}bg-orange-600{% elif forloop.counter0 == 1 %}bg-yellow-400{% elif forloop.counter0 == 2 %}bg-orange-300{% elif forloop.counter0 == 3 %}bg-orange-200{% else %}bg-gray-300{% endif %}"
                    style="width: {{ item.pct|floatformat:2|cut:',' }}%;">
                  </div>
                {% endfor %}
              </div>

              <div class="mt-3 space-y-1">
                {% for item in breakdown_items %}
                  <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-700 font-medium">{{ item.nome }}</span>
                    <span class="text-gray-500">
                      R$ {{ item.valor|floatformat:2 }} • {{ item.pct|floatformat:0 }}%
                    </span>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-sm text-gray-500">Sem dados de categorias no período.</p>
            {% endif %}

            <div class="mt-4 h-24">
              <canvas id="chartDespesasMini"></canvas>
            </div>
          </div>
        </div>

      </div>

      <!-- Fluxo de caixa -->
      <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-5">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <h2 class="text-sm font-semibold text-gray-800">Fluxo de caixa (6 meses)</h2>
            <span class="text-gray-400 cursor-help" title="Ligue/desligue séries para comparar">
              <i class="fa-solid fa-circle-info"></i>
            </span>
          </div>

          <div class="flex items-center gap-2">
            <button id="btnIncome" class="text-xs font-semibold px-3 py-1 rounded-full bg-gray-100 text-gray-700">Receita</button>
            <button id="btnExpense" class="text-xs font-semibold px-3 py-1 rounded-full bg-gray-100 text-gray-700">Despesa</button>
            <button id="btnSavings" class="text-xs font-semibold px-3 py-1 rounded-full bg-gray-900 text-white">Saldo</button>
          </div>
        </div>

        <div class="mt-3">
          <p class="text-2xl font-bold text-gray-900">R$ {{ saldo_mes|floatformat:2 }}</p>
          <p class="text-xs text-gray-500">saldo do {{ periodo_label|lower }}</p>
        </div>

        <div class="mt-4 h-60">
          <canvas id="graficoMeses"></canvas>
        </div>
      </div>

      <!-- Transações -->
      <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-semibold text-gray-800">Transações recentes</h2>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="border-b text-xs text-gray-500">
                <th class="py-2 font-semibold">Data</th>
                <th class="py-2 font-semibold">Tipo</th>
                <th class="py-2 font-semibold">Valor</th>
                <th class="py-2 font-semibold">Descrição</th>
              </tr>
            </thead>
            <tbody class="text-sm">
              {% for t in ultimas_transacoes %}
              <tr class="border-b">
                <td class="py-3 text-gray-700">{{ t.data_realizacao|date:"d/m/Y" }}</td>
                <td class="py-3 text-gray-700">{{ t.get_tipo_display }}</td>
                <td class="py-3 font-semibold text-gray-900">R$ {{ t.valor|floatformat:2 }}</td>
                <td class="py-3 text-gray-700">{{ t.descricao }}</td>
              </tr>
              {% empty %}
              <tr>
                <td class="py-3 text-gray-500" colspan="4">Sem transações recentes.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- Right -->
    <div class="space-y-6">

      <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-sm font-semibold text-gray-800">Próximas contas</h2>
          <button class="w-9 h-9 rounded-xl border border-gray-200 text-gray-700 text-lg leading-none">+</button>
        </div>

        <div class="mt-4 space-y-3">
          {% for c in upcoming_bills %}
            <div class="border border-gray-100 rounded-2xl p-4 flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-gray-900">{{ c.descricao }}</p>
                <p class="text-xs text-gray-500">{{ c.data_vencimento|date:"d/m/Y" }}</p>
                {% if c.categoria %}
                  <p class="text-xs text-gray-500">{{ c.categoria.nome }}</p>
                {% endif %}
              </div>

              <div class="text-right">
                <p class="text-sm font-bold text-gray-900">R$ {{ c.valor|floatformat:2 }}</p>
                <span class="inline-block mt-1 text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">
                  Programado
                </span>
              </div>
            </div>
          {% empty %}
            <p class="text-sm text-gray-500">Nenhuma conta pendente futura.</p>
          {% endfor %}
        </div>

        <button class="mt-4 w-full bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm font-semibold py-2 rounded-xl">
          Ver tudo
        </button>
      </div>

      <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-6">
        <h2 class="text-sm font-semibold text-gray-800 mb-4">Status das contas</h2>
        <div class="h-56">
          <canvas id="graficoContas"></canvas>
        </div>
      </div>

      <div class="bg-white border border-gray-100 rounded-2xl shadow-sm p-6">
        <h2 class="text-sm font-semibold text-gray-800 mb-4">Resumo (3 meses)</h2>

        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="border-b text-xs text-gray-500">
                <th class="py-2 font-semibold">Mês</th>
                <th class="py-2 font-semibold">Receita</th>
                <th class="py-2 font-semibold">Gastos</th>
                <th class="py-2 font-semibold">Total</th>
              </tr>
            </thead>
            <tbody class="text-sm">
              {% for r in resumo_3_meses %}
              <tr class="border-b">
                <td class="py-3 text-gray-700">{{ r.mes }}/{{ r.ano }}</td>
                <td class="py-3 text-gray-700">R$ {{ r.receita|floatformat:2 }}</td>
                <td class="py-3 text-gray-700">R$ {{ r.gastos|floatformat:2 }}</td>
                <td class="py-3 font-semibold text-gray-900">R$ {{ r.total|floatformat:2 }}</td>
              </tr>
              {% empty %}
              <tr>
                <td class="py-3 text-gray-500" colspan="5">Sem resumo.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  const brl = new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" });

  function setPeriodo(value) {
    const url = new URL(window.location.href);
    url.searchParams.set("periodo", value);
    window.location.href = url.toString();
  }

  function makeGradient(ctx, top, bottom) {
    const g = ctx.createLinearGradient(0, 0, 0, 180);
    g.addColorStop(0, top);
    g.addColorStop(1, bottom);
    return g;
  }

  function makeDailyLine(canvasId, labels, dataArr, borderColor, fillTop, fillBottom) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;

    const ctx = canvas.getContext("2d");
    const bg = makeGradient(ctx, fillTop, fillBottom);

    return new Chart(canvas, {
      type: "line",
      data: {
        labels,
        datasets: [{
          data: dataArr,
          tension: 0.35,
          borderColor,
          backgroundColor: bg,
          borderWidth: 2,
          pointRadius: 2,
          pointHoverRadius: 4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (items) => `Dia ${items?.[0]?.label || ""}`,
              label: (ctx) => brl.format(ctx.parsed.y || 0)
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: {
              maxRotation: 0,
              callback: (value, index) => {
                const label = labels[index] || "";
                const day = Number(label);
                return (day === 1 || day % 5 === 0) ? label : "";
              }
            }
          },
          y: {
            beginAtZero: true,
            ticks: { callback: (v) => brl.format(v) }
          }
        }
      }
    });
  }

  // JSON
  const mesesLabels = JSON.parse(document.getElementById("mesesLabels").textContent);
  const receitas6m = JSON.parse(document.getElementById("receitas6m").textContent).map(v => Number(v) || 0);
  const despesas6m = JSON.parse(document.getElementById("despesas6m").textContent).map(v => Number(v) || 0);
  const saldos6m = JSON.parse(document.getElementById("saldos6m").textContent).map(v => Number(v) || 0);

  const diasLabels = JSON.parse(document.getElementById("diasLabels").textContent);
  const receitasDias = JSON.parse(document.getElementById("receitasDias").textContent).map(v => Number(v) || 0);
  const despesasDias = JSON.parse(document.getElementById("despesasDias").textContent).map(v => Number(v) || 0);

  makeDailyLine("chartReceitas", diasLabels, receitasDias, "#16a34a", "rgba(34,197,94,0.22)", "rgba(34,197,94,0)");
  makeDailyLine("chartDespesasMini", diasLabels, despesasDias, "#f97316", "rgba(249,115,22,0.20)", "rgba(249,115,22,0)");

  // Donut contas
  const donutEl = document.getElementById("graficoContas");
  if (donutEl) {
    const pagas = Number("{{ contas_pagas|default:0 }}");
    const pendentes = Number("{{ contas_pendentes|default:0 }}");
    const atrasadas = Number("{{ contas_atrasadas|default:0 }}");

    let labels = ["Pagas", "Pendentes", "Atrasadas"];
    let data = [pagas, pendentes, atrasadas];
    let colors = ["#22c55e", "#3b82f6", "#ef4444"];

    if ((pagas + pendentes + atrasadas) === 0) {
      labels = ["Sem contas"];
      data = [1];
      colors = ["#e5e7eb"];
    }

    new Chart(donutEl, {
      type: "doughnut",
      data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: "bottom" } }, cutout: "70%" }
    });
  }

  // Fluxo de caixa
  const cashFlowEl = document.getElementById("graficoMeses");
  let cashFlowChart = null;

  function setButtonState(btn, active) {
    if (!btn) return;
    btn.classList.toggle("bg-gray-900", active);
    btn.classList.toggle("text-white", active);
    btn.classList.toggle("bg-gray-100", !active);
    btn.classList.toggle("text-gray-700", !active);
  }

  function toggleDataset(idx, btn) {
    if (!cashFlowChart) return;
    const ds = cashFlowChart.data.datasets[idx];
    ds.hidden = !ds.hidden;
    cashFlowChart.update();
    setButtonState(btn, !ds.hidden);
  }

  if (cashFlowEl) {
    cashFlowChart = new Chart(cashFlowEl, {
      type: "line",
      data: {
        labels: mesesLabels,
        datasets: [
          { label: "Receita", data: receitas6m, borderColor: "#16a34a", borderWidth: 2, tension: 0.35, pointRadius: 2, fill: false, hidden: true },
          { label: "Despesa", data: despesas6m, borderColor: "#ef4444", borderWidth: 2, tension: 0.35, pointRadius: 2, fill: false, hidden: true },
          { label: "Saldo", data: saldos6m, borderColor: "#3b82f6", borderWidth: 3, tension: 0.35, pointRadius: 3, fill: false, hidden: false },
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: "top" },
          tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${brl.format(ctx.parsed.y || 0)}` } }
        },
        scales: {
          x: { grid: { display: false } },
          y: {
            beginAtZero: true,
            grid: { color: (ctx) => (ctx.tick.value === 0 ? "#9ca3af" : "rgba(156,163,175,0.2)") },
            ticks: { callback: (v) => brl.format(v) }
          }
        }
      }
    });
  }

  const btnIncome = document.getElementById("btnIncome");
  const btnExpense = document.getElementById("btnExpense");
  const btnSavings = document.getElementById("btnSavings");

  if (btnIncome) { btnIncome.addEventListener("click", () => toggleDataset(0, btnIncome)); setButtonState(btnIncome, false); }
  if (btnExpense) { btnExpense.addEventListener("click", () => toggleDataset(1, btnExpense)); setButtonState(btnExpense, false); }
  if (btnSavings) { btnSavings.addEventListener("click", () => toggleDataset(2, btnSavings)); setButtonState(btnSavings, true); }
</script>

{% endblock %}
