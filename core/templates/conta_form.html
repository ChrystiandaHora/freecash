{% extends "base.html" %}
{% load static %}
{% load l10n %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight text-gray-900 dark:text-white">
      {% if modo == "edit" %}
        {% if is_receita %}Editar Receita{% else %}Editar Conta{% endif %}
      {% else %}
        {% if is_receita %}Nova Receita{% else %}Nova Conta{% endif %}
      {% endif %}
    </h1>
    <p class="mt-2 text-sm text-gray-500 dark:text-slate-400">
      {% if modo == "edit" %}
        Atualize os dados e gerencie o status do lançamento.
      {% else %}
        {% if is_receita %}Registre uma nova entrada financeira.{% else %}Cadastre uma nova conta a pagar.{% endif %}
      {% endif %}
    </p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column: Form (2 cols) -->
    <div class="lg:col-span-2">
      <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-2xl shadow-sm overflow-hidden">
        <!-- Card Header -->
        <div class="px-6 py-5 border-b border-gray-100 dark:border-slate-700">
          <div class="flex items-center gap-4">
            <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-gradient-to-br {% if is_receita %}from-emerald-500 to-teal-600{% else %}from-rose-500 to-red-600{% endif %} text-white shadow-lg {% if is_receita %}shadow-emerald-500/30{% else %}shadow-rose-500/30{% endif %}">
              <i class="fa-solid {% if is_receita %}fa-arrow-trend-up{% else %}fa-file-invoice-dollar{% endif %} text-xl"></i>
            </div>
            <div>
              <h2 class="text-lg font-bold text-gray-900 dark:text-white">
                {% if modo == "edit" %}{{ conta.descricao|truncatechars:30 }}{% else %}Dados do Lançamento{% endif %}
              </h2>
              <p class="text-sm text-gray-500 dark:text-slate-400">
                {% if modo == "edit" %}ID #{{ conta.id }}{% else %}Campos com * são obrigatórios{% endif %}
              </p>
            </div>
          </div>
        </div>

        <!-- Card Body -->
        <div class="p-6">
          <form method="post" class="space-y-5">
            {% csrf_token %}

            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-1">Descrição *</label>
              <input type="text"
                     name="descricao"
                     required
                     value="{{ conta.descricao|default_if_none:'' }}"
                     placeholder="Ex: Internet, Luz, Aluguel"
                     class="block w-full rounded-xl border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white px-4 py-3 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm">
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-1">Valor *</label>
                <input type="number"
                       step="0.01"
                       name="valor"
                       required
                       value="{% if conta.valor != None %}{{ conta.valor|unlocalize }}{% endif %}"
                       placeholder="0,00"
                       class="block w-full rounded-xl border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white px-4 py-3 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm">
                {% if modo == "edit" and conta.eh_parcelada %}
                  <p class="mt-1 text-xs text-gray-500 dark:text-slate-400">
                    Em parcelamento, o valor pode variar por parcela.
                  </p>
                {% endif %}
              </div>

              <div>
                <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-1">Vencimento *</label>
                <input type="date"
                       name="data_prevista"
                       required
                       value="{% if conta.data_prevista %}{{ conta.data_prevista|date:'Y-m-d' }}{% endif %}"
                       class="block w-full rounded-xl border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white px-4 py-3 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm">
              </div>
            </div>

            {% if categorias|length == 1 %}
              <input type="hidden" name="categoria" value="{{ categorias.first.id }}">
            {% else %}
            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-1">Categoria</label>
              <select name="categoria"
                      class="block w-full rounded-xl border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white px-4 py-3 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm">
                <option value="">Selecione...</option>
                {% for cat in categorias %}
                  <option value="{{ cat.id }}"
                    {% if conta.categoria and conta.categoria.id == cat.id %}selected{% endif %}>
                    {{ cat.nome }}
                  </option>
                {% endfor %}
              </select>
            </div>
            {% endif %}

            <div>
              <label class="block text-sm font-semibold text-gray-900 dark:text-white mb-1">Forma de pagamento</label>
              <select name="forma_pagamento"
                      class="block w-full rounded-xl border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white px-4 py-3 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm">
                <option value="">Selecione...</option>
                {% for f in formas %}
                  <option value="{{ f.id }}"
                    {% if conta.forma_pagamento and conta.forma_pagamento.id == f.id %}selected{% endif %}>
                    {{ f.nome }}
                  </option>
                {% endfor %}
              </select>
            </div>

            {% if modo != "edit" %}
            <!-- Opções de Multiplicar/Parcelar -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <!-- Multiplicar -->
              <div class="rounded-xl border border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-700/50 p-4">
                <label class="flex items-center justify-between cursor-pointer">
                  <div>
                    <p class="text-sm font-semibold text-gray-900 dark:text-white">Repetir mensal</p>
                    <p class="text-xs text-gray-500 dark:text-slate-400">Criar cópias para os próximos meses</p>
                  </div>
                  <input id="multiplicar" type="checkbox" name="multiplicar" value="1"
                         class="w-5 h-5 rounded border-gray-300 dark:border-slate-600 text-emerald-600 focus:ring-emerald-500">
                </label>
                <div id="multiplicaBox" class="mt-3 hidden">
                  <select id="numero_multiplicacoes" name="numero_multiplicacoes" disabled
                          class="w-full rounded-xl border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white px-3 py-2 text-sm">
                    <option value="2">2x</option><option value="3">3x</option><option value="4">4x</option>
                    <option value="5">5x</option><option value="6">6x</option><option value="7">7x</option>
                    <option value="8">8x</option><option value="9">9x</option><option value="10">10x</option>
                    <option value="11">11x</option><option value="12">12x</option>
                  </select>
                </div>
              </div>

              <!-- Parcelar -->
              <div class="rounded-xl border border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-700/50 p-4">
                <label class="flex items-center justify-between cursor-pointer">
                  <div>
                    <p class="text-sm font-semibold text-gray-900 dark:text-white">Parcelar</p>
                    <p class="text-xs text-gray-500 dark:text-slate-400">Dividir o valor em parcelas</p>
                  </div>
                  <input id="parcelado" type="checkbox" name="parcelado" value="1"
                         class="w-5 h-5 rounded border-gray-300 dark:border-slate-600 text-emerald-600 focus:ring-emerald-500">
                </label>
                <div id="parcelasBox" class="mt-3 hidden">
                  <select id="numero_parcelas" name="numero_parcelas" disabled
                          class="w-full rounded-xl border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-900 dark:text-white px-3 py-2 text-sm">
                    <option value="2">2x</option><option value="3">3x</option><option value="4">4x</option>
                    <option value="5">5x</option><option value="6">6x</option><option value="7">7x</option>
                    <option value="8">8x</option><option value="9">9x</option><option value="10">10x</option>
                    <option value="11">11x</option><option value="12">12x</option>
                  </select>
                </div>
              </div>
            </div>
            {% endif %}

            {% if modo == "edit" and conta.eh_parcelada and conta.grupo_parcelamento %}
            <div class="rounded-xl border border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/20 p-4">
              <label class="flex items-center gap-3">
                <input id="aplicar_grupo" type="checkbox" name="aplicar_grupo" value="1"
                       class="w-5 h-5 rounded border-gray-300 text-amber-600 focus:ring-amber-500">
                <div>
                  <p class="text-sm font-semibold text-amber-800 dark:text-amber-300">Aplicar em todas as parcelas</p>
                  <p class="text-xs text-amber-600 dark:text-amber-400">Atualiza descrição, categoria e forma de pagamento</p>
                </div>
              </label>
            </div>
            {% endif %}

            <!-- Submit Buttons -->
            <div class="flex items-center gap-3 pt-4">
              <button type="submit"
                      class="inline-flex items-center justify-center gap-2 rounded-xl bg-gradient-to-r {% if is_receita %}from-emerald-500 to-teal-600{% else %}from-gray-800 to-gray-900{% endif %} px-6 py-3 text-sm font-bold text-white hover:opacity-90 shadow-lg transition-all">
                <i class="fa-solid {% if modo == 'edit' %}fa-check{% else %}fa-plus{% endif %}"></i>
                {% if modo == "edit" %}Salvar Alterações{% else %}{% if is_receita %}Cadastrar Receita{% else %}Cadastrar Conta{% endif %}{% endif %}
              </button>

              <a href="{% if is_receita %}{% url 'receitas' %}{% else %}{% url 'contas_pagar' %}{% endif %}"
                 class="inline-flex items-center justify-center rounded-xl border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 px-6 py-3 text-sm font-semibold text-gray-700 dark:text-slate-300 hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors">
                Cancelar
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Right Column: Sidebar (1 col) -->
    <div class="lg:col-span-1 space-y-4">

      {% if modo == "edit" %}
      <!-- Status Card -->
      <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-2xl p-5">
        <div class="flex items-center gap-3 mb-4">
          <div class="flex h-10 w-10 items-center justify-center rounded-xl {% if conta.transacao_realizada %}bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400{% else %}bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400{% endif %}">
            <i class="fa-solid {% if conta.transacao_realizada %}fa-check-circle{% else %}fa-clock{% endif %}"></i>
          </div>
          <div>
            <h3 class="font-semibold text-gray-900 dark:text-white">Status</h3>
            <p class="text-xs {% if conta.transacao_realizada %}text-emerald-600 dark:text-emerald-400{% else %}text-blue-600 dark:text-blue-400{% endif %}">
              {% if conta.transacao_realizada %}Paga{% else %}Pendente{% endif %}
            </p>
          </div>
        </div>

        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-500 dark:text-slate-400">Vencimento</span>
            <span class="font-medium text-gray-900 dark:text-white">{{ conta.data_prevista|date:"d/m/Y" }}</span>
          </div>
          {% if conta.transacao_realizada %}
          <div class="flex justify-between">
            <span class="text-gray-500 dark:text-slate-400">Paga em</span>
            <span class="font-medium text-emerald-600 dark:text-emerald-400">{{ conta.data_realizacao|date:"d/m/Y" }}</span>
          </div>
          {% endif %}
          {% if conta.eh_parcelada %}
          <div class="flex justify-between">
            <span class="text-gray-500 dark:text-slate-400">Parcela</span>
            <span class="font-medium text-gray-900 dark:text-white">{{ conta.parcela_numero }}/{{ conta.parcela_total }}</span>
          </div>
          {% endif %}
        </div>

        <form method="post" class="mt-4">
          {% csrf_token %}
          {% if conta.transacao_realizada %}
            <button type="submit" name="acao" value="desmarcar_paga"
                    class="w-full inline-flex items-center justify-center rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-4 py-2.5 text-sm font-semibold text-gray-700 dark:text-slate-300 hover:bg-gray-50 dark:hover:bg-slate-600 transition-colors">
              <i class="fa-solid fa-xmark mr-2"></i> Desmarcar como paga
            </button>
          {% else %}
            <button type="submit" name="acao" value="marcar_paga"
                    class="w-full inline-flex items-center justify-center rounded-xl bg-emerald-600 px-4 py-2.5 text-sm font-bold text-white hover:bg-emerald-500 shadow-lg shadow-emerald-500/30 transition-all">
              <i class="fa-solid fa-check mr-2"></i> Marcar como paga
            </button>
          {% endif %}
        </form>
      </div>

      <!-- Danger Zone -->
      <div class="bg-white dark:bg-slate-800 border border-red-200 dark:border-red-900/50 rounded-2xl p-5">
        <div class="flex items-center gap-3 mb-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400">
            <i class="fa-solid fa-trash"></i>
          </div>
          <h3 class="font-semibold text-gray-900 dark:text-white">Zona de Perigo</h3>
        </div>
        <form method="post" action="{% url 'apagar_conta' conta.id %}"
              onsubmit="return confirm('Tem certeza que deseja apagar esta conta?');">
          {% csrf_token %}
          {% if conta.eh_parcelada and conta.grupo_parcelamento %}
          <label class="flex items-center gap-2 text-sm text-gray-600 dark:text-slate-400 mb-3">
            <input type="checkbox" name="apagar_grupo" value="1" class="rounded border-gray-300 dark:border-slate-600">
            Apagar todas as parcelas
          </label>
          {% endif %}
          <button type="submit"
                  class="w-full inline-flex items-center justify-center rounded-xl bg-red-600 px-4 py-2.5 text-sm font-bold text-white hover:bg-red-500 transition-all">
            Apagar {% if is_receita %}Receita{% else %}Conta{% endif %}
          </button>
        </form>
      </div>

      {% else %}
      <!-- Info Card (New Mode) -->
      <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-2xl p-5">
        <div class="flex items-center gap-3 mb-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">
            <i class="fa-solid fa-info-circle"></i>
          </div>
          <h3 class="font-semibold text-gray-900 dark:text-white">Como funciona</h3>
        </div>
        <ul class="text-sm text-gray-600 dark:text-slate-400 space-y-2">
          <li class="flex items-start gap-2">
            <i class="fa-solid fa-check text-emerald-500 mt-0.5"></i>
            Preencha o formulário ao lado
          </li>
          <li class="flex items-start gap-2">
            <i class="fa-solid fa-check text-emerald-500 mt-0.5"></i>
            O lançamento aparece na lista
          </li>
          <li class="flex items-start gap-2">
            <i class="fa-solid fa-check text-emerald-500 mt-0.5"></i>
            Clique na linha para editar
          </li>
        </ul>
      </div>

      <!-- Quick Action -->
      <a href="{% if is_receita %}{% url 'receitas' %}{% else %}{% url 'contas_pagar' %}{% endif %}"
         class="flex items-center gap-3 bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-2xl p-5 hover:bg-gray-50 dark:hover:bg-slate-700/50 transition-colors">
        <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-gray-100 dark:bg-slate-700 text-gray-600 dark:text-slate-400">
          <i class="fa-solid fa-arrow-left"></i>
        </div>
        <div>
          <h3 class="font-semibold text-gray-900 dark:text-white">Voltar</h3>
          <p class="text-xs text-gray-500 dark:text-slate-400">Ver todos os lançamentos</p>
        </div>
      </a>
      {% endif %}

    </div>
  </div>
</div>

<script>
  (function () {
    const form = document.querySelector("form");
    if (!form) return;

    const btnMark = document.querySelector('button[name="acao"][value="marcar_paga"]');
    const btnUnmark = document.querySelector('button[name="acao"][value="desmarcar_paga"]');

    function confirmAction(btn, msg) {
      if (!btn) return;
      btn.addEventListener("click", function (e) {
        if (!confirm(msg)) {
          e.preventDefault();
          e.stopPropagation();
        }
      });
    }

    confirmAction(btnMark, "Marcar esta conta como paga agora?");
    confirmAction(btnUnmark, "Desmarcar esta conta como paga?");
  })();
</script>

<script>
  (function () {
    const chkParcelado = document.getElementById("parcelado");
    const boxParcelas = document.getElementById("parcelasBox");
    const selParcelas = document.getElementById("numero_parcelas");

    const chkMultiplicar = document.getElementById("multiplicar");
    const boxMultiplica = document.getElementById("multiplicaBox");
    const selMultiplica = document.getElementById("numero_multiplicacoes");

    const valorInput = document.querySelector('input[name="valor"]');
    const parcelasOptions = selParcelas ? Array.from(selParcelas.options) : [];

    function parseToCents(raw) {
      if (!raw) return null;
      let s = String(raw).trim().replace(/\s/g, "");
      if (s.includes(",")) {
        s = s.replace(/\./g, "");
        s = s.replace(",", ".");
      }
      const num = Number(s);
      if (!Number.isFinite(num) || num <= 0) return null;
      return Math.round(num * 100);
    }

    function centsToBRL(cents) {
      return (cents / 100).toFixed(2).replace(".", ",");
    }

    function splitCents(totalCents, n) {
      const base = Math.floor(totalCents / n);
      const resto = totalCents % n;
      const parcelas = [];
      for (let i = 1; i <= n; i++) {
        parcelas.push(base + (i <= resto ? 1 : 0));
      }
      return parcelas;
    }

    function setVisible(el, visible) {
      if (!el) return;
      el.classList.toggle("hidden", !visible);
    }

    function updateParcelasOptions() {
      if (!selParcelas || !valorInput) return;
      const totalCents = parseToCents(valorInput.value);

      parcelasOptions.forEach(opt => {
        const n = parseInt(opt.value, 10);
        if (!totalCents) {
          opt.textContent = `${n}x`;
          return;
        }
        const parcelas = splitCents(totalCents, n);
        opt.textContent = `${n}x de R$ ${centsToBRL(parcelas[0])}`;
      });
    }

    function updateUI() {
      if (chkParcelado && chkMultiplicar && chkParcelado.checked && chkMultiplicar.checked) {
        chkMultiplicar.checked = false;
      }

      setVisible(boxParcelas, chkParcelado && chkParcelado.checked);
      setVisible(boxMultiplica, chkMultiplicar && chkMultiplicar.checked);

      if (selParcelas && chkParcelado) selParcelas.disabled = !chkParcelado.checked;
      if (selMultiplica && chkMultiplicar) selMultiplica.disabled = !chkMultiplicar.checked;

      updateParcelasOptions();
    }

    if (chkParcelado) chkParcelado.addEventListener("change", updateUI);
    if (chkMultiplicar) chkMultiplicar.addEventListener("change", updateUI);
    if (selParcelas) selParcelas.addEventListener("change", updateUI);
    if (valorInput) valorInput.addEventListener("input", updateUI);

    updateUI();
  })();
</script>

{% endblock %}
