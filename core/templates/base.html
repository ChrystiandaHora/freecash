<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}FreeCash{% endblock %}</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {% load static %}
    <link rel="icon" type="image/png" sizes="512x512" href="{% static 'freecash/freecash_icon_512_dark.png' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css" >

    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">

        <!-- MESSAGES -->
        {% if messages %}
        <div
            id="toast-stack"
            class="fixed top-4 right-4 z-50 w-full max-w-sm space-y-3 px-4 sm:px-0"
            aria-live="polite"
            aria-atomic="true"
        >
            {% for msg in messages %}
            <div
                class="
                toast-item
                pointer-events-auto
                w-full rounded-2xl border p-4 shadow-lg
                bg-white/95 backdrop-blur
                flex items-start gap-3
                opacity-0 translate-y-2
                transition duration-300 ease-out
                {% if msg.tags == 'success' %} border-emerald-200 {% elif msg.tags == 'error' %} border-red-200 {% elif msg.tags == 'warning' %} border-amber-200 {% else %} border-gray-200 {% endif %}
                "
                data-timeout="4500"
                role="alert"
            >
                <!-- Icon -->
                <div
                class="
                    mt-0.5 flex h-8 w-8 shrink-0 items-center justify-center rounded-xl
                    {% if msg.tags == 'success' %} bg-emerald-50 text-emerald-700
                    {% elif msg.tags == 'error' %} bg-red-50 text-red-700
                    {% elif msg.tags == 'warning' %} bg-amber-50 text-amber-700
                    {% else %} bg-gray-50 text-gray-700 {% endif %}
                "
                >
                {% if msg.tags == "success" %}
                    <i class="fa-solid fa-circle-check text-emerald-400 text-[20px]" aria-hidden="true"></i>
                {% elif msg.tags == "error" %}
                    <i class="fa-solid fa-circle-xmark text-red-400 text-[20px]" aria-hidden="true"></i>
                {% elif msg.tags == "warning" %}
                    <i class="fa-solid fa-triangle-exclamation text-yellow-400 text-[20px]" aria-hidden="true"></i>
                {% else %}
                    <i class="fa-solid fa-circle-info text-sky-400 text-[20px]" aria-hidden="true"></i>
                {% endif %}
                </div>

                <!-- Content -->
                <div class="min-w-0 flex-1">
                <p class="text-sm font-semibold text-gray-900">
                    {% if msg.tags == "success" %}Sucesso
                    {% elif msg.tags == "error" %}Erro
                    {% elif msg.tags == "warning" %}Atenção
                    {% else %}Aviso{% endif %}
                </p>
                <p class="mt-0.5 text-sm text-gray-600 break-words">
                    {{ msg }}
                </p>

                <!-- Progress bar -->
                <div class="mt-3 h-1 w-full overflow-hidden rounded-full bg-gray-100">
                    <div
                    class="
                        toast-bar h-1 w-full
                        {% if msg.tags == 'success' %} bg-emerald-500
                        {% elif msg.tags == 'error' %} bg-red-500
                        {% elif msg.tags == 'warning' %} bg-amber-500
                        {% else %} bg-gray-500 {% endif %}
                    "
                    style="transform: translateX(-100%);"
                    ></div>
                </div>
                </div>

                <!-- Close -->
                <button
                type="button"
                class="toast-close -mr-1 inline-flex h-8 w-8 items-center justify-center rounded-xl text-gray-400 hover:bg-gray-100 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-900/10"
                aria-label="Fechar"
                >
                    <i class="fa-solid fa-xmark text-[20px]" aria-hidden="true"></i>
                </button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- MENU LATERAL -->
        <aside class="w-64 bg-slate-900 text-slate-200 px-6 py-8 flex flex-col shadow-xl">

            <!-- Logo -->
            <div class="mb-10">
                <div class="flex items-center gap-3">
                    <h1 class="text-3xl font-extrabold tracking-tight text-emerald-400">
                    FreeCash
                    </h1>

                    <img
                    src="{% static 'freecash/Icon.png' %}"
                    alt="FreeCash"
                    class="w-[64px] h-[64px] flex-shrink-0"
                    >
                </div>

                <p class="text-slate-500 text-sm mt-1">
                    Controle financeiro pessoal
                </p>
            </div>

            <!-- MENU -->
            <nav class="flex-1 space-y-3">
                <a href="{% url 'dashboard' %}" class="block py-2 px-3 rounded-lg hover:bg-slate-800 transition">
                    Dashboard
                </a>

                <a href="{% url 'contas_pagar' %}" class="block py-2 px-3 rounded-lg hover:bg-slate-800 transition">
                    Contas
                </a>

                <a href="{% url 'receitas' %}" class="block py-2 px-3 rounded-lg hover:bg-slate-800 transition">
                    Receitas
                </a>

                <a href="{% url 'transacoes' %}" class="block py-2 px-3 rounded-lg hover:bg-slate-800 transition">
                    Transações
                </a>

                <a href="{% url 'formas_pagamento' %}" class="block py-2 px-3 rounded-lg hover:bg-slate-800 transition">
                    Formas de Pagamento
                </a>

                <a href="{% url 'importar' %}" class="block py-2 px-3 rounded-lg hover:bg-slate-800 transition">
                    Importar dados
                </a>

                <a href="#" class="block py-2 px-3 rounded-lg hover:bg-slate-800 transition">
                    Exportar backup
                </a>
            </nav>

            <!-- RODAPÉ -->
            <div class="mt-10 pt-6 border-t border-slate-700">
                
                <!-- Última atualização -->
                <div>
                    <p class="text-xs text-slate-500 mb-1">Última atualização</p>
                    <div class="flex items-center space-x-2">
                        <span 
                            id="atualizacao-dot"
                            class="w-2.5 h-2.5 rounded-full bg-slate-500 transition"></span>

                        <span class="text-sm text-slate-300">
                            {% if request.user.config.atualizada_em %}
                                {{ request.user.config.atualizada_em|date:"d/m/Y H:i" }}
                            {% else %}
                                Nunca
                            {% endif %}
                        </span>
                    </div>
                </div>

                <!-- Último backup -->
                <div class="mt-4">
                    <p class="text-xs text-slate-500 mb-1">Último backup</p>

                    <span class="text-sm text-slate-300">
                        {% if request.user.config.ultimo_export_em %}
                            {{ request.user.config.ultimo_export_em|date:"d/m/Y H:i" }}
                        {% else %}
                            Nunca
                        {% endif %}
                    </span>
                </div>

                <!-- Logout -->
                <a href="{% url 'logout' %}" 
                class="mt-6 block w-full text-center py-2 rounded-lg bg-red-600 hover:bg-red-700 transition text-white font-semibold">
                    Sair
                </a>
            </div>

        </aside>

        <!-- ÁREA PRINCIPAL -->
        <main class="flex-1 p-6 overflow-y-auto">
            {% block content %}
            {% endblock %}
        </main>

    </div>

    <script>
        const ultimaAtualizacao = "{{ request.user.configusuario.atualizada_em|date:'Y-m-d H:i:s' }}";
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            if (!ultimaAtualizacao) return;

            const dot = document.getElementById("atualizacao-dot");
            if (!dot) return;

            const agora = new Date();
            const ultima = new Date(ultimaAtualizacao);
            const diffMs = agora - ultima;
            const diffMin = diffMs / 60000;

            if (diffMin <= 5) {
                dot.classList.remove("bg-slate-500");
                dot.classList.add("bg-emerald-400");
            } else if (diffMin <= 1440) {
                dot.classList.remove("bg-slate-500");
                dot.classList.add("bg-yellow-400");
            } else {
                dot.classList.remove("bg-slate-500");
                dot.classList.add("bg-red-500");
            }
        });
    </script>
    <script>
        (function () {
            const stack = document.getElementById("toast-stack");
            if (!stack) return;

            const toasts = Array.from(stack.querySelectorAll(".toast-item"));

            function showToast(el) {
            // anima entrada
            requestAnimationFrame(() => {
                el.classList.remove("opacity-0", "translate-y-2");
                el.classList.add("opacity-100", "translate-y-0");
            });

            // anima barra de tempo
            const ms = parseInt(el.getAttribute("data-timeout") || "4500", 10);
            const bar = el.querySelector(".toast-bar");
            if (bar) {
                bar.style.transition = `transform ${ms}ms linear`;
                requestAnimationFrame(() => {
                bar.style.transform = "translateX(0)";
                });
            }

            // auto-dismiss
            const t = setTimeout(() => dismissToast(el), ms);

            // botão fechar
            const btn = el.querySelector(".toast-close");
            if (btn) {
                btn.addEventListener("click", () => {
                clearTimeout(t);
                dismissToast(el);
                });
            }
            }

            function dismissToast(el) {
            el.classList.remove("opacity-100", "translate-y-0");
            el.classList.add("opacity-0", "translate-y-2");

            // remove do DOM após transição
            setTimeout(() => {
                el.remove();
                // se não sobrar nenhum, remove o container
                if (stack.querySelectorAll(".toast-item").length === 0) {
                stack.remove();
                }
            }, 250);
            }

            toasts.forEach(showToast);
        })();
    </script>

</body>
</html>
