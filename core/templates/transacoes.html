{% extends "base.html" %}
{% block content %}

<div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">

  <!-- Header -->
  <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Transações</h1>
      <p class="text-sm text-gray-500 dark:text-slate-400">Filtre, encontre e revise suas movimentações.</p>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-2xl shadow-sm p-4 mb-6">
    <form method="get" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-2">
      
      <!-- Ano -->
      <select name="ano"
              class="w-full rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:focus:ring-emerald-500/20">
        <option value="">Ano</option>
        {% for a in anos %}
          <option value="{{ a }}" {% if request.GET.ano|stringformat:"s" == a|stringformat:"s" %}selected{% endif %}>
            {{ a }}
          </option>
        {% endfor %}
      </select>

      <!-- Mês -->
      <select name="mes"
              class="w-full rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:focus:ring-emerald-500/20">
        <option value="">Mês</option>
        {% for m in meses %}
          <option value="{{ m }}" {% if request.GET.mes|stringformat:"s" == m|stringformat:"s" %}selected{% endif %}>
            {{ m }}
          </option>
        {% endfor %}
      </select>

      <!-- Tipo -->
      <select name="tipo"
              class="w-full rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:focus:ring-emerald-500/20">
        <option value="">Tipo</option>
        <option value="receita" {% if request.GET.tipo == "receita" %}selected{% endif %}>Receita</option>
        <option value="despesa" {% if request.GET.tipo == "despesa" %}selected{% endif %}>Despesa</option>
      </select>

      <!-- Categoria -->
      <select name="categoria"
              class="w-full rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:focus:ring-emerald-500/20">
        <option value="">Categoria</option>
        {% for c in categorias %}
          <option value="{{ c.id }}" {% if request.GET.categoria|stringformat:"s" == c.id|stringformat:"s" %}selected{% endif %}>
            {{ c.nome }}
          </option>
        {% endfor %}
      </select>

      <!-- Forma -->
      <select name="forma_pagamento"
              class="w-full rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-emerald-500/20 dark:focus:ring-emerald-500/20">
        <option value="">Forma</option>
        {% for f in formas_pagamento %}
          <option value="{{ f.id }}" {% if request.GET.forma_pagamento|stringformat:"s" == f.id|stringformat:"s" %}selected{% endif %}>
            {{ f.nome }}
          </option>
        {% endfor %}
      </select>

      <!-- Actions -->
      <div class="sm:col-span-1 lg:col-span-1 flex gap-2 justify-end mt-2 lg:mt-0">
          <button class="w-full inline-flex items-center justify-center rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-4 py-2 text-sm font-semibold text-gray-700 dark:text-slate-200 hover:bg-gray-50 dark:hover:bg-slate-600 transition-colors">
            Filtrar
          </button>
      </div>
      <div class="sm:col-span-1 lg:col-span-1 flex gap-2 justify-start mt-2 lg:mt-0">
          <a href="{% url 'transacoes' %}"
             class="w-full inline-flex items-center justify-center rounded-xl bg-gray-100 dark:bg-slate-700/50 px-4 py-2 text-sm font-semibold text-gray-700 dark:text-slate-300 hover:bg-gray-200 dark:hover:bg-slate-600 transition-colors">
            Limpar
          </a>
      </div>
    </form>
  </div>

  <!-- Table -->
  <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-2xl shadow-sm overflow-hidden">

    <!-- Table header -->
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between px-6 py-4 border-b border-gray-100 dark:border-slate-700">
      <div>
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white">Lista de transações</h3>
        <p class="mt-1 text-xs text-gray-500 dark:text-slate-400">
          {% if total_count %}
            Mostrando {{ page_obj.start_index }} a {{ page_obj.end_index }} de {{ total_count }} registro(s).
          {% else %}
            Nada para exibir.
          {% endif %}
        </p>
      </div>

      <!-- Per page (separate GET form to avoid duplicate inputs) -->
      <form method="get" class="flex items-center gap-2">
        {% for key, value in request.GET.items %}
          {% if key != "per_page" and key != "page" %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
          {% endif %}
        {% endfor %}

        <label class="text-xs font-semibold text-gray-600 dark:text-slate-400">Por página</label>
        <select name="per_page"
                onchange="this.form.submit()"
                class="rounded-xl border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-gray-900/10 dark:focus:ring-emerald-500/20">
          <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
          <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
          <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
          <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
          <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
          <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
        </select>
      </form>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full">
        <thead class="bg-gray-50 dark:bg-slate-700/50">
          <tr class="text-left text-xs font-semibold text-gray-500 dark:text-slate-400">
            <th class="px-6 py-3">Descrição</th>
            <th class="px-6 py-3">Data</th>
            <th class="px-6 py-3">Tipo</th>
            <th class="px-6 py-3">Categoria</th>
            <th class="px-6 py-3">Pagamento</th>
            <th class="px-6 py-3 text-right">Valor</th>
          </tr>
        </thead>

        <tbody class="divide-y divide-gray-100 dark:divide-slate-700 text-sm">
          {% for t in transacoes %}
            <tr class="hover:bg-gray-50 dark:hover:bg-slate-700/50 cursor-pointer transition-colors"
                onclick="window.location='{% if t.tipo == 'R' %}{% url 'receita_editar' t.id %}{% else %}{% url 'conta_editar' t.id %}{% endif %}'">
              <td class="px-6 py-4">
                <div class="font-semibold text-gray-900 dark:text-white">
                  {{ t.descricao|default:"Sem descrição" }}
                </div>
                <div class="mt-1 text-xs text-gray-500 dark:text-slate-400">ID #{{ t.id }}</div>
              </td>

              <td class="px-6 py-4 text-gray-700 dark:text-slate-300 whitespace-nowrap">
                {{ t.data_realizacao|date:"d/m/Y" }}
              </td>

              <td class="px-6 py-4">
                {% if t.tipo == "R" %}
                  <span class="inline-flex items-center rounded-full bg-green-100 dark:bg-green-900/30 px-3 py-1 text-xs font-semibold text-green-700 dark:text-green-400">
                    Receita
                  </span>
                {% else %}
                  <span class="inline-flex items-center rounded-full bg-red-100 dark:bg-red-900/30 px-3 py-1 text-xs font-semibold text-red-700 dark:text-red-400">
                    Despesa
                  </span>
                {% endif %}
              </td>

              <td class="px-6 py-4 text-gray-700 dark:text-slate-300">
                {% if t.categoria %}
                  {{ t.categoria.nome }}
                {% else %}
                  <span class="text-gray-400 dark:text-slate-500">Sem categoria</span>
                {% endif %}
              </td>

              <td class="px-6 py-4 text-gray-700 dark:text-slate-300">
                {% if t.forma_pagamento %}
                  {{ t.forma_pagamento.nome }}
                {% else %}
                  <span class="text-gray-400 dark:text-slate-500">Não informado</span>
                {% endif %}
              </td>

              <td class="px-6 py-4 text-right font-semibold whitespace-nowrap {% if t.tipo == 'R' %}text-emerald-700 dark:text-emerald-400{% else %}text-red-700 dark:text-red-400{% endif %}">
                {% if t.tipo == 'R' %}+{% else %}-{% endif %} R$ {{ t.valor|floatformat:2 }}
              </td>
            </tr>
          {% empty %}
            <tr>
              <td class="px-6 py-10 text-center" colspan="6">
                <div class="mx-auto max-w-sm">
                  <p class="text-sm font-semibold text-gray-900 dark:text-white">Nenhuma transação encontrada</p>
                  <p class="mt-1 text-sm text-gray-500 dark:text-slate-400">Tente limpar os filtros ou ajustar o período.</p>
                  <a href="{% url 'transacoes' %}" class="mt-4 inline-flex items-center justify-center rounded-xl bg-gray-900 dark:bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800 dark:hover:bg-emerald-500 transition-all shadow-lg shadow-gray-900/20 dark:shadow-emerald-900/20">
                    Limpar filtros
                  </a>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% include "_pagination.html" with page=page_obj qs=querystring %}

  </div>

</div>

{% endblock %}
