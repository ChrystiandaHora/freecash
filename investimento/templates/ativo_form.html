{% extends 'base.html' %}

{% block title %}{% if form.instance.pk %}Editar{% else %}Novo{% endif %} Ativo | FreeCash{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">

  <!-- Header -->
  <div class="space-y-1">
    <h1 class="text-xl font-semibold text-gray-900 dark:text-white">
      <i class="fa-solid fa-wallet text-emerald-500 mr-2"></i>
      {% if form.instance.pk %}Editar Ativo{% else %}Novo Ativo{% endif %}
    </h1>
    <p class="text-sm text-gray-500 dark:text-gray-400">
      {% if form.instance.pk %}Atualize as informações do ativo{% else %}Cadastre um novo ativo e sua posição inicial{% endif %}
    </p>
  </div>

  <!-- Form Card -->
  <div class="bg-white dark:bg-slate-800 border border-gray-100 dark:border-slate-700 rounded-2xl shadow-sm p-6">
    <form method="post" class="space-y-8">
      {% csrf_token %}

      <!-- 1. Informações Básicas -->
      <div class="space-y-4">
        <h3 class="text-sm font-medium text-gray-900 dark:text-white border-b border-gray-100 dark:border-slate-700 pb-2">
            Informações Básicas
        </h3>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <!-- Ticker -->
            <div>
                <label for="id_ticker" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ticker *</label>
                <input type="text" name="ticker" id="id_ticker" value="{{ form.ticker.value|default:'' }}"
                    class="w-full rounded-xl border border-gray-200 dark:border-slate-600 px-4 py-2.5 text-sm text-gray-900 dark:text-white
                            focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400
                            placeholder:text-gray-400 dark:placeholder:text-gray-500 bg-white dark:bg-slate-900 uppercase"
                    placeholder="Ex: PETR4, CDB-ITAU" required>
                {% if form.ticker.errors %}
                <p class="mt-1 text-xs text-red-600">{{ form.ticker.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Nome -->
            <div>
                <label for="id_nome" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome</label>
                <input type="text" name="nome" id="id_nome" value="{{ form.nome.value|default:'' }}"
                    class="w-full rounded-xl border border-gray-200 dark:border-slate-600 px-4 py-2.5 text-sm text-gray-900 dark:text-white
                            focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400
                            placeholder:text-gray-400 dark:placeholder:text-gray-500 bg-white dark:bg-slate-900"
                    placeholder="Ex: Petrobras PN, CDB Itaú 2026">
            </div>
        </div>

        <!-- Classificação (Subcategoria) -->
        <div>
            <label for="id_subcategoria" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Classificação (Subcategoria)</label>
            <select name="subcategoria" id="id_subcategoria"
                    class="w-full rounded-xl border border-gray-200 dark:border-slate-600 px-4 py-2.5 text-sm text-gray-900 dark:text-white
                            focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400
                            bg-white dark:bg-slate-900">
                <option value="">Selecione a subcategoria</option>
                {% for sub in form.subcategoria.field.queryset %}
                <option value="{{ sub.id }}" 
                        data-classe-nome="{{ sub.categoria.classe.nome }}"
                        {% if form.subcategoria.value|stringformat:"s" == sub.id|stringformat:"s" %}selected{% endif %}>
                    {{ sub }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
             <!-- Moeda -->
            <div>
                <label for="id_moeda" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Moeda</label>
                <select name="moeda" id="id_moeda"
                        class="w-full rounded-xl border border-gray-200 dark:border-slate-600 px-4 py-2.5 text-sm text-gray-900 dark:text-white
                            focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400
                            bg-white dark:bg-slate-900">
                <option value="BRL" {% if form.moeda.value == 'BRL' %}selected{% endif %}>BRL - Real</option>
                <option value="USD" {% if form.moeda.value == 'USD' %}selected{% endif %}>USD - Dólar</option>
                <option value="EUR" {% if form.moeda.value == 'EUR' %}selected{% endif %}>EUR - Euro</option>
                </select>
            </div>
            
             <!-- Ativo Checkbox -->
             <div class="flex items-end pb-3">
                <div class="flex items-center gap-3">
                    <input type="checkbox" name="ativo" id="id_ativo"
                        {% if form.ativo.value %}checked{% endif %}
                        class="w-4 h-4 rounded border-gray-300 dark:border-slate-600 text-emerald-600 focus:ring-emerald-500 bg-white dark:bg-slate-700">
                    <label for="id_ativo" class="text-sm text-gray-700 dark:text-gray-300">Ativo na carteira?</label>
                </div>
             </div>
        </div>
      </div>

      <!-- 2. Detalhes Renda Fixa (Condicional) -->
      <div id="fixed-income-section" class="space-y-4 pt-2 hidden">
        <h3 class="text-sm font-medium text-gray-900 dark:text-white border-b border-gray-100 dark:border-slate-700 pb-2">
            Detalhes de Renda Fixa (Obrigatório para RF)
        </h3>
        
        <!-- Emissor e Vencimento -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <label for="id_emissor" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Emissor</label>
                <input type="text" name="emissor" id="id_emissor" value="{{ form.emissor.value|default:'' }}"
                    class="w-full rounded-xl border border-gray-200 dark:border-slate-600 px-4 py-2.5 text-sm text-gray-900 dark:text-white
                            focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400
                            placeholder:text-gray-400 dark:placeholder:text-gray-500 bg-white dark:bg-slate-900"
                    placeholder="Ex: Banco XP, Tesouro Nacional">
            </div>
            <div>
                <label for="id_data_vencimento" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data de Vencimento</label>
                <input type="date" name="data_vencimento" id="id_data_vencimento" value="{{ form.data_vencimento.value|date:'Y-m-d' }}"
                    class="w-full rounded-xl border border-gray-200 dark:border-slate-600 px-4 py-2.5 text-sm text-gray-900 dark:text-white
                            focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400
                            bg-white dark:bg-slate-900">
            </div>
        </div>

        <!-- Indexador e Taxa -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <label for="id_indexador" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Indexador</label>
                <select name="indexador" id="id_indexador"
                        class="w-full rounded-xl border border-gray-200 dark:border-slate-600 px-4 py-2.5 text-sm text-gray-900 dark:text-white
                            focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400
                            bg-white dark:bg-slate-900">
                    <option value="">Selecione...</option>
                    {% for value, text in form.indexador.field.choices %}
                    <option value="{{ value }}" {% if form.indexador.value == value %}selected{% endif %}>{{ text }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                 <label for="id_taxa" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Taxa / Percentual</label>
                 <div class="relative">
                    <input type="number" step="0.01" name="taxa" id="id_taxa" value="{{ form.taxa.value|default:'' }}"
                        class="w-full rounded-xl border border-gray-200 dark:border-slate-600 px-4 py-2.5 text-sm text-gray-900 dark:text-white
                                focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400
                                placeholder:text-gray-400 dark:placeholder:text-gray-500 bg-white dark:bg-slate-900"
                        placeholder="Ex: 100 ou 6.5">
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <span class="text-gray-500 dark:text-gray-400 sm:text-sm">%</span>
                    </div>
                </div>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Ex: 100 para 100% do CDI, ou 6.0 para IPCA+6%</p>
            </div>
        </div>
      </div>

      <!-- 3. Posição Inicial (Só aparece no criar) -->
      {% if not form.instance.pk %}
      <div class="space-y-4 pt-2">
        <div class="flex items-center justify-between border-b border-gray-100 dark:border-slate-700 pb-2">
             <h3 class="text-sm font-medium text-gray-900 dark:text-white">
                Posição Inicial (Já comprei)
            </h3>
            <span class="text-xs text-emerald-600 bg-emerald-50 dark:bg-emerald-900/20 px-2 py-1 rounded-full">Opcional</span>
        </div>
        
        <div class="bg-gray-50 dark:bg-slate-700/30 rounded-xl p-4 border border-gray-100 dark:border-slate-700">
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Preencha abaixo se você já possui este ativo. O sistema criará a primeira transação automaticamente.
            </p>
             <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <!-- Quantidade -->
                <div>
                    <label for="id_quantidade_inicial" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Qtd. Inicial</label>
                    <input type="number" step="0.00000001" name="quantidade_inicial" id="id_quantidade_inicial"
                        class="w-full rounded-xl border border-gray-200 dark:border-slate-600 px-4 py-2.5 text-sm text-gray-900 dark:text-white
                                focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400
                                bg-white dark:bg-slate-900"
                        placeholder="0.00">
                </div>
                <!-- Preço Médio -->
                <div>
                    <label for="id_preco_medio_inicial" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Preço Pago</label>
                    <input type="number" step="0.0001" name="preco_medio_inicial" id="id_preco_medio_inicial"
                        class="w-full rounded-xl border border-gray-200 dark:border-slate-600 px-4 py-2.5 text-sm text-gray-900 dark:text-white
                                focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400
                                bg-white dark:bg-slate-900"
                        placeholder="R$ 0.00">
                </div>
                <!-- Data Compra -->
                <div>
                    <label for="id_data_compra" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data Compra</label>
                    <input type="date" name="data_compra" id="id_data_compra"
                        class="w-full rounded-xl border border-gray-200 dark:border-slate-600 px-4 py-2.5 text-sm text-gray-900 dark:text-white
                                focus:outline-none focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 dark:focus:border-emerald-400
                                bg-white dark:bg-slate-900">
                </div>
            </div>
        </div>
      </div>
      {% endif %}

      <!-- 3. Posição Atual (Apenas Visualização na Edição) -->
      {% if form.instance.pk %}
      <div class="space-y-4 pt-2">
        <div class="flex items-center justify-between border-b border-gray-100 dark:border-slate-700 pb-2">
            <h3 class="text-sm font-medium text-gray-900 dark:text-white">
                Posição Atual
            </h3>
             <a href="{% url 'investimento:transacao_criar' %}?ativo={{ form.instance.id }}" 
                class="text-xs font-medium text-emerald-600 hover:text-emerald-700 dark:text-emerald-400">
                <i class="fa-solid fa-plus mr-1"></i> Nova Transação
             </a>
        </div>
        
        <div class="bg-gray-50 dark:bg-slate-700/30 rounded-xl p-4 border border-gray-100 dark:border-slate-700">
             <div class="grid grid-cols-2 sm:grid-cols-3 gap-6">
                <!-- Quantidade -->
                <div>
                    <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Quantidade</label>
                    <p class="text-lg font-bold text-gray-900 dark:text-white tabular-nums">
                        {{ form.instance.quantidade|floatformat:4 }}
                    </p>
                </div>
                <!-- Preço Médio -->
                <div>
                     <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Preço Médio</label>
                    <p class="text-lg font-bold text-gray-900 dark:text-white tabular-nums">
                        R$ {{ form.instance.preco_medio|floatformat:2 }}
                    </p>
                </div>
                 <!-- Link Transações -->
                <div class="col-span-2 sm:col-span-1 flex items-center">
                     <a href="{% url 'investimento:transacao_listar' %}?ativo={{ form.instance.id }}" 
                        class="text-sm text-emerald-600 hover:text-emerald-700 font-medium hover:underline">
                        Ver histórico de transações
                     </a>
                </div>
            </div>
             <div class="mt-3 flex items-start gap-2 bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg text-xs text-blue-700 dark:text-blue-300">
                <i class="fa-solid fa-circle-info mt-0.5"></i>
                <p>O saldo é calculado automaticamente com base nas suas compras e vendas. Não edite este valor manualmente.</p>
            </div>
        </div>
      </div>
      {% endif %}

      <!-- Buttons -->
      <div class="flex items-center gap-3 pt-6 border-t border-gray-100 dark:border-slate-700">
        <button type="submit"
                class="inline-flex items-center justify-center rounded-xl px-6 py-2.5 text-sm font-semibold
                       bg-emerald-600 dark:bg-emerald-600/90 text-white hover:bg-emerald-700 dark:hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-600/20 shadow-lg shadow-emerald-900/20">
          <i class="fa-solid fa-check mr-2"></i>
          {% if form.instance.pk %}Salvar Alterações{% else %}Cadastrar Ativo{% endif %}
        </button>
        <a href="{% url 'investimento:ativo_listar' %}"
           class="inline-flex items-center justify-center rounded-xl px-6 py-2.5 text-sm font-semibold
                  bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-gray-900/10">
          Cancelar
        </a>
      </div>
    </form>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const subSelect = document.getElementById('id_subcategoria');
        const fixedSection = document.getElementById('fixed-income-section');
        
        function toggleFixedIncome() {
            if (!subSelect || !fixedSection) return;
            
            const selectedOption = subSelect.options[subSelect.selectedIndex];
            const classeNome = selectedOption ? selectedOption.getAttribute('data-classe-nome') : '';
            
            console.log('Selected Class:', classeNome);

            if (classeNome === 'Renda Fixa') {
                fixedSection.classList.remove('hidden');
            } else {
                fixedSection.classList.add('hidden');
            }
        }

        if (subSelect) {
            subSelect.addEventListener('change', toggleFixedIncome);
            toggleFixedIncome(); // Run on init
        }
    });
</script>
{% endblock %}
